name: Build CleverKeys APK

on:
  workflow_dispatch:
  push:
  pull_request:

permissions:
  contents: write

jobs:
  Build-APK:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Restore debug keystore from GitHub Secrets
      run: |
        # DEBUG_KEYSTORE should contain base64-encoded content of debug.keystore.asc
        # Create it with: cat debug.keystore.asc | base64 -w0
        # Or use GPG: gpg -c --passphrase "debug0" --batch debug.keystore && base64 -w0 debug.keystore.gpg
        if [[ ! "${{ secrets.DEBUG_KEYSTORE }}" = "" ]]; then
            echo "Restoring debug keystore from GitHub secrets"
            echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > "debug.keystore.asc"
            if [[ -s "debug.keystore.asc" ]]; then
                gpg -d --passphrase "debug0" --batch "debug.keystore.asc" > "debug.keystore"
                echo "Debug keystore restored ($(wc -c < debug.keystore) bytes)"
            else
                echo "Warning: decoded keystore.asc is empty"
            fi
        else
            echo "No DEBUG_KEYSTORE secret found, will auto-generate keystore"
        fi

    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Build debug APK
      run: ./gradlew assembleDebug
      env:
        DEBUG_KEYSTORE: "debug.keystore"
        DEBUG_KEYSTORE_PASSWORD: debug0
        DEBUG_KEY_ALIAS: debug
        DEBUG_KEY_PASSWORD: debug0

    - name: Artifact naming
      run: |
        artifact="${{github.repository_owner}} ${{github.ref_name}}"
        artifact="${artifact//\//-}"
        echo "artifact=${artifact}" >> $GITHUB_ENV

    - name: Upload debug APK
      uses: actions/upload-artifact@v4
      with:
        name: "${{env.artifact}} debug_apk"
        path: build/outputs/apk/debug/*.apk

    - name: Get short SHA
      id: sha
      run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Upload to releases (on every push to main)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        files: build/outputs/apk/debug/*.apk
        tag_name: "dev-${{ steps.sha.outputs.short }}"
        name: "CleverKeys Dev Build (${{ steps.sha.outputs.short }})"
        prerelease: false
        body: |
          CleverKeys Android APK - Development Build

          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Date:** ${{ github.event.head_commit.timestamp }}

          ## Features
          - Neural swipe prediction with local processing
          - Enhanced gesture support from Unexpected Keyboard
          - Complete customization and transparency

          ## Installation
          1. Download APK
          2. Enable "Unknown sources" in Android settings
          3. Install and activate in Language & Input settings

    - name: Upload to releases (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/outputs/apk/debug/*.apk
        name: "CleverKeys ${{ github.ref_name }}"
        prerelease: true
        body: |
          CleverKeys Android APK - Privacy-first neural keyboard (Pre-release)

          ## Features
          - Neural swipe prediction with local processing
          - Enhanced gesture support from Unexpected Keyboard
          - Complete customization and transparency

          ## Installation
          1. Download APK
          2. Enable "Unknown sources" in Android settings
          3. Install and activate in Language & Input settings

          Built on [Unexpected Keyboard](https://github.com/Julow/Unexpected-Keyboard) foundation.
