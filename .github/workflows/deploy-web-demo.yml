name: Deploy CleverKeys Web Demo

on:
  push:
    branches: [ main ]
    paths: [ 'web_demo/**', 'README.md' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS files
        run: git lfs install && git lfs pull

      - name: Prepare CleverKeys website and demo
        run: |
          mkdir -p deploy/demo

          if [ -d "web_demo" ]; then
            echo "ðŸ“ Setting up CleverKeys website..."

            # Copy new homepage (index.html stays as-is)
            if [ -f "web_demo/index.html" ]; then
              cp web_demo/index.html deploy/
              echo "âœ… Homepage ready"
            fi

            # Move neural swipe demo to /demo/ subfolder
            echo "ðŸ“ Setting up neural swipe demo in /demo/..."
            if [ -f "web_demo/swipe-onnx.html" ]; then
              cp web_demo/swipe-onnx.html deploy/demo/index.html
              echo "âœ… Demo page ready at /demo/"
            fi

            # Copy demo supporting files (ONNX models, JS, JSON)
            cp web_demo/*.onnx deploy/demo/ 2>/dev/null || echo "No ONNX models"
            cp web_demo/*.js deploy/demo/ 2>/dev/null || echo "No JS files"
            cp web_demo/*.json deploy/demo/ 2>/dev/null || echo "No JSON files"
          fi

          echo "âœ… Website structure prepared:"
          echo "   / - Homepage"
          echo "   /demo/ - Neural swipe typing demo"
          ls -laR deploy/

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4