name: Deploy CleverKeys Web Demo

on:
  push:
    branches: [ main ]
    paths: [ 'web_demo/**', 'README.md' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS files
        run: git lfs install && git lfs pull

      - name: Prepare CleverKeys website and demo
        run: |
          mkdir -p deploy/demo
          mkdir -p deploy/specs

          if [ -d "web_demo" ]; then
            echo "ðŸ“ Setting up CleverKeys website..."

            # Copy new homepage
            if [ -f "web_demo/index.html" ]; then
              cp web_demo/index.html deploy/
              echo "âœ… Homepage ready"
            fi

            # Copy demo page (use demo/index.html if exists, otherwise under construction)
            echo "ðŸ“ Setting up demo in /demo/..."
            if [ -f "web_demo/demo/index.html" ]; then
              cp web_demo/demo/index.html deploy/demo/index.html
              echo "âœ… Demo page ready (under construction)"
            elif [ -f "web_demo/swipe-onnx.html" ]; then
              cp web_demo/swipe-onnx.html deploy/demo/index.html
              echo "âœ… Demo page ready (neural swipe)"
            fi

            # Copy specs documentation
            echo "ðŸ“ Setting up specs documentation in /specs/..."
            if [ -d "web_demo/specs" ]; then
              cp -r web_demo/specs/* deploy/specs/
              echo "âœ… Specs documentation ready"
            fi

            # Copy demo supporting files (for when demo is restored)
            cp web_demo/*.onnx deploy/demo/ 2>/dev/null || echo "No ONNX models"
            cp web_demo/*.js deploy/demo/ 2>/dev/null || echo "No JS files"
          fi

          echo "âœ… Website structure prepared:"
          echo "   / - Homepage"
          echo "   /demo/ - Demo (under construction)"
          echo "   /specs/ - Documentation"
          ls -laR deploy/

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4