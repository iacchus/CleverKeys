name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # REPRODUCIBILITY: Pin exact Java version for deterministic DEX output
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # REPRODUCIBILITY: Pin build-tools version for deterministic AAPT2 output
    - name: Install pinned build-tools
      run: |
        sdkmanager "build-tools;35.0.0"
        echo "BUILD_TOOLS_VERSION=35.0.0" >> $GITHUB_ENV

    - name: Add Android SDK tools to PATH
      run: |
        # Use pinned build-tools version for reproducibility
        BUILD_TOOLS_DIR="$ANDROID_HOME/build-tools/35.0.0"
        echo "$BUILD_TOOLS_DIR" >> $GITHUB_PATH
        echo "BUILD_TOOLS_DIR=$BUILD_TOOLS_DIR" >> $GITHUB_ENV
        echo "ðŸ“¦ Build tools: $BUILD_TOOLS_DIR"
        echo "ðŸ“¦ Java: $(java -version 2>&1 | head -1)"
        ls -la $BUILD_TOOLS_DIR/zipalign $BUILD_TOOLS_DIR/apksigner 2>/dev/null || echo "Tools check"

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Extract version info
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

        # Parse semantic version: vMAJOR.MINOR.PATCH -> code = MAJOR*10000 + MINOR*100 + PATCH
        VERSION=${TAG_NAME#v}
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)
        PATCH=$(echo $VERSION | cut -d. -f3 | sed 's/[^0-9].*//')
        VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
        echo "ðŸ“¦ Version: $VERSION (code: $VERSION_CODE)"

    - name: Verify tag matches build.gradle version
      run: |
        TAG_VERSION=${GITHUB_REF_NAME#v}

        # Extract VERSION_MAJOR, VERSION_MINOR, VERSION_PATCH from build.gradle
        GRADLE_MAJOR=$(grep "VERSION_MAJOR" build.gradle | head -1 | sed 's/.*= *//' | tr -d ' ')
        GRADLE_MINOR=$(grep "VERSION_MINOR" build.gradle | head -1 | sed 's/.*= *//' | tr -d ' ')
        GRADLE_PATCH=$(grep "VERSION_PATCH" build.gradle | head -1 | sed 's/.*= *//' | tr -d ' ')
        GRADLE_VERSION="${GRADLE_MAJOR}.${GRADLE_MINOR}.${GRADLE_PATCH}"

        echo "ðŸ·ï¸  Git Tag Version: $TAG_VERSION"
        echo "ðŸ“¦ Gradle Version:  $GRADLE_VERSION"

        if [ "$TAG_VERSION" != "$GRADLE_VERSION" ]; then
          echo "::error::VERSION MISMATCH! Git tag ($TAG_VERSION) does not match build.gradle ($GRADLE_VERSION)"
          echo "Please update VERSION_MAJOR/MINOR/PATCH in build.gradle to match the tag."
          exit 1
        fi

        echo "âœ… Version match confirmed!"

    - name: Decode signing keystore
      run: |
        echo "${{ secrets.SIGNING_KEY }}" | base64 -d > ${{ github.workspace }}/release.keystore
        echo "RELEASE_KEYSTORE=${{ github.workspace }}/release.keystore" >> $GITHUB_ENV

    - name: Print R8 Version
      run: ./gradlew printR8Version

    - name: Build signed release APK
      run: ./gradlew assembleRelease --stacktrace
      env:
        RELEASE_KEYSTORE: ${{ github.workspace }}/release.keystore
        RELEASE_KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        RELEASE_KEY_ALIAS: ${{ secrets.ALIAS }}
        RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    - name: List and rename release APKs
      run: |
        cd build/outputs/apk/release
        echo "=== APKs before rename ==="
        ls -la *.apk || echo "No APKs found!"

        # ABI split APKs: tribixbite.cleverkeys_<code>_<abi>.apk
        # Rename to user-friendly format with proper ABI names for Obtainium compatibility
        for apk in *.apk; do
          if [[ "$apk" == *"arm64-v8a"* ]]; then
            mv "$apk" "CleverKeys-${{ env.TAG_NAME }}-arm64-v8a.apk"
          elif [[ "$apk" == *"armeabi-v7a"* ]]; then
            mv "$apk" "CleverKeys-${{ env.TAG_NAME }}-armeabi-v7a.apk"
          elif [[ "$apk" == *"x86_64"* ]]; then
            mv "$apk" "CleverKeys-${{ env.TAG_NAME }}-x86_64.apk"
          fi
        done

        echo "=== APKs after rename ==="
        ls -la CleverKeys-*.apk

        # Show APK info
        echo ""
        echo "ðŸ“¦ Version: ${{ env.VERSION }} (code: ${{ env.VERSION_CODE }})"
        echo "ðŸ“± ABI versionCodes:"
        echo "   - arm64: $((${{ env.VERSION_CODE }} * 10 + 2))"
        echo "   - armv7: $((${{ env.VERSION_CODE }} * 10 + 1))"
        echo "   - x86_64: $((${{ env.VERSION_CODE }} * 10 + 3))"

    - name: Generate changelog
      run: |
        # Extract changelog from recent commits
        echo "## What's New in ${{ env.TAG_NAME }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --grep="feat\|fix\|perf\|refactor" >> CHANGELOG.md
        else
          echo "- Initial release with neural swipe typing" >> CHANGELOG.md
          echo "- Complete ONNX transformer integration" >> CHANGELOG.md
          echo "- Hardware acceleration support" >> CHANGELOG.md
          echo "- Privacy-first local processing" >> CHANGELOG.md
        fi

        echo "" >> CHANGELOG.md
        echo "## Build Information" >> CHANGELOG.md
        echo "- **Version**: ${{ env.VERSION }}" >> CHANGELOG.md
        echo "- **VersionCode**: ${{ env.VERSION_CODE }} (base)" >> CHANGELOG.md
        echo "- **Package**: tribixbite.cleverkeys" >> CHANGELOG.md
        echo "- **Min Android**: 5.0 (API 21)" >> CHANGELOG.md
        echo "- **Target Android**: 14 (API 34)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## Install Options" >> CHANGELOG.md
        echo "| Source | Link |" >> CHANGELOG.md
        echo "|--------|------|" >> CHANGELOG.md
        echo "| GitHub | Download APK below for your device |" >> CHANGELOG.md
        echo "| F-Droid | Coming soon (auto-update enabled) |" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## APK Variants" >> CHANGELOG.md
        echo "| ABI | Devices | VersionCode |" >> CHANGELOG.md
        echo "|-----|---------|-------------|" >> CHANGELOG.md
        echo "| arm64 | Most modern phones (2016+) | $((${{ env.VERSION_CODE }} * 10 + 2)) |" >> CHANGELOG.md
        echo "| armv7 | Older 32-bit devices | $((${{ env.VERSION_CODE }} * 10 + 1)) |" >> CHANGELOG.md
        echo "| x86_64 | Emulators, Chromebooks | $((${{ env.VERSION_CODE }} * 10 + 3)) |" >> CHANGELOG.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: build/outputs/apk/release/CleverKeys-*.apk
        name: CleverKeys ${{ env.TAG_NAME }}
        tag_name: ${{ env.TAG_NAME }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to artifact
      uses: actions/upload-artifact@v4
      with:
        name: cleverkeys-release-${{ env.TAG_NAME }}
        path: |
          build/outputs/apk/release/CleverKeys-*.apk
          CHANGELOG.md
        retention-days: 365

    - name: Release summary
      run: |
        echo "## Release ${{ env.TAG_NAME }} Published!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Version Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Base VersionCode**: ${{ env.VERSION_CODE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download" >> $GITHUB_STEP_SUMMARY
        echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### APK Variants" >> $GITHUB_STEP_SUMMARY
        echo "| ABI | VersionCode | Use For |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|-------------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| arm64 | $((${{ env.VERSION_CODE }} * 10 + 2)) | Most modern phones |" >> $GITHUB_STEP_SUMMARY
        echo "| armv7 | $((${{ env.VERSION_CODE }} * 10 + 1)) | Older 32-bit devices |" >> $GITHUB_STEP_SUMMARY
        echo "| x86_64 | $((${{ env.VERSION_CODE }} * 10 + 3)) | Emulators, Chromebooks |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Distribution" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Release: âœ… Available now" >> $GITHUB_STEP_SUMMARY
        echo "- F-Droid: Auto-update will pick up this version" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: release
    if: success()

    steps:
    - name: Release notification
      run: |
        echo "CleverKeys ${{ github.ref_name }} has been successfully released!"
        echo "Users can now download the latest APK with neural swipe typing."
