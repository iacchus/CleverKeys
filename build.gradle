plugins {
  id 'com.android.application' version '8.6.0'
  id 'org.jetbrains.kotlin.android' version '1.9.20'
}

dependencies {
  implementation "androidx.window:window-java:1.3.0"
  implementation "androidx.core:core:1.16.0"
  implementation "androidx.appcompat:appcompat:1.6.1"
  implementation "androidx.multidex:multidex:2.0.1"
  implementation "com.google.android.material:material:1.11.0"
  implementation "androidx.viewpager2:viewpager2:1.0.0"
  implementation "androidx.recyclerview:recyclerview:1.3.2"
  implementation "androidx.preference:preference-ktx:1.2.1"

  // Kotlin dependencies
  implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.20"
  implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3"

  // Jetpack Compose dependencies (for settings UI)
  implementation "androidx.activity:activity-compose:1.8.2"
  implementation "androidx.compose.ui:ui:1.5.4"
  implementation "androidx.compose.ui:ui-tooling-preview:1.5.4"
  implementation "androidx.compose.material3:material3:1.1.2"
  implementation "androidx.compose.foundation:foundation:1.5.4"

  // Lifecycle dependencies for Compose in InputMethodService (Fix ViewTreeLifecycleOwner crash)
  implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.6.2"
  implementation "androidx.savedstate:savedstate-ktx:1.2.1"

  // Reorderable for drag-and-drop in Layout Manager
  implementation "org.burnoutcrew.composereorderable:reorderable:0.9.6"

  // ONNX Runtime for neural swipe prediction (upgraded for boolean tensor support)
  implementation "com.microsoft.onnxruntime:onnxruntime-android:1.20.0"

  // Gson for JSON serialization/deserialization (backup/restore functionality)
  implementation "com.google.code.gson:gson:2.10.1"

  testImplementation "junit:junit:4.13.2"
  testImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3"
  testImplementation "org.robolectric:robolectric:4.11.1"
  testImplementation "androidx.test:core:1.5.0"

  // Android instrumentation test dependencies
  androidTestImplementation "androidx.test.ext:junit:1.1.5"
  androidTestImplementation "androidx.test:runner:1.5.2"
  androidTestImplementation "androidx.test:rules:1.5.0"
  androidTestImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3"
}

// Version management functions
def getVersionCode() {
    def versionFile = file("version.properties")
    def versionCode = 51

    if (versionFile.exists()) {
        def props = new Properties()
        props.load(new FileInputStream(versionFile))
        versionCode = props.getProperty("VERSION_CODE", "51").toInteger()
    }

    // Increment version code
    versionCode++

    // Save back to file
    versionFile.parentFile.mkdirs()
    def props = new Properties()
    props.setProperty("VERSION_CODE", versionCode.toString())
    props.setProperty("VERSION_NAME", "1.1.${versionCode - 50}")
    props.setProperty("BUILD_TIME", new Date().toString())
    props.store(new FileOutputStream(versionFile), "CleverKeys Version")

    println "üöÄ CleverKeys version incremented to: ${versionCode}"
    return versionCode
}

def getVersionName() {
    def versionFile = file("version.properties")
    if (versionFile.exists()) {
        def props = new Properties()
        props.load(new FileInputStream(versionFile))
        return props.getProperty("VERSION_NAME", "1.1.1")
    }
    return "1.1.1"
}

android {
  namespace 'tribixbite.keyboard2'
  compileSdk 35

  defaultConfig {
    applicationId "tribixbite.keyboard2"
    minSdk 21
    targetSdkVersion 35
    versionCode getVersionCode()
    versionName getVersionName()
    testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    multiDexEnabled true
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }

  kotlinOptions {
    jvmTarget = "1.8"
  }

  buildFeatures {
    compose true
  }

  composeOptions {
    kotlinCompilerExtensionVersion = '1.5.4'
  }

  sourceSets {
    main {
      manifest.srcFile 'AndroidManifest.xml'
      kotlin.srcDirs = ['src/main/kotlin']
      java.srcDirs = ['src/main/java']
      res.srcDirs = ['res', 'build/generated-resources']
      assets.srcDirs = ['assets', 'src/main/assets']
    }

    test {
      kotlin.srcDirs = ['src/test/kotlin']
      java.srcDirs = ['src/test/java']
    }

    androidTest {
      kotlin.srcDirs = ['src/androidTest/kotlin']
    }
  }

  signingConfigs {
    // Debug builds will always be signed. If no environment variables are set, a default
    // keystore will be initialized by the task initDebugKeystore and used. This keystore
    // can be uploaded to GitHub secrets by following instructions in CONTRIBUTING.md
    // in order to always receive correctly signed debug APKs from the CI.
    debug {
      storeFile(System.env.DEBUG_KEYSTORE ? file(System.env.DEBUG_KEYSTORE) : file("debug.keystore"))
      storePassword(System.env.DEBUG_KEYSTORE_PASSWORD ? "$System.env.DEBUG_KEYSTORE_PASSWORD" : "debug0")
      keyAlias(System.env.DEBUG_KEY_ALIAS ? "$System.env.DEBUG_KEY_ALIAS" : "debug")
      keyPassword(System.env.DEBUG_KEY_PASSWORD ? "$System.env.DEBUG_KEY_PASSWORD" : "debug0")
    }

    release {
      if (System.env.RELEASE_KEYSTORE) {
        storeFile file(System.env.RELEASE_KEYSTORE)
        storePassword "$System.env.RELEASE_KEYSTORE_PASSWORD"
        keyAlias "$System.env.RELEASE_KEY_ALIAS"
        keyPassword "$System.env.RELEASE_KEY_PASSWORD"
      }
    }
  }

  buildTypes {
    release {
      minifyEnabled true
      shrinkResources true
      debuggable false
      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
      resValue "string", "app_name", "@string/app_name_release"
      signingConfig signingConfigs.release
    }

    debug {
      // FIX: Removed applicationIdSuffix ".debug" to fix keyboard service crash
      // The .debug suffix prevented Android from properly binding InputMethodService
      minifyEnabled false
      shrinkResources false
      debuggable true
      // applicationIdSuffix ".debug"  // DO NOT ADD THIS BACK - it breaks IME binding!
      resValue "string", "app_name", "@string/app_name_debug"
      resValue "bool", "debug_logs", "true"
      signingConfig signingConfigs.debug
    }
  }

  // Name outputs after the application ID.
  android.applicationVariants.all { variant ->
    variant.outputs.all {
      outputFileName = "${applicationId}.apk"
    }
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }

  lint {
    baseline = file("lint-baseline.xml")
    abortOnError = false
    checkReleaseBuilds = false
  }

  testOptions {
    unitTests {
      includeAndroidResources = true
      returnDefaultValues = true
    }
  }
}

// Skip Robolectric tests on ARM64 (no Conscrypt native libraries available)
def isArm64 = System.getProperty("os.arch") in ["aarch64", "arm64"]
if (isArm64) {
  tasks.withType(Test).configureEach {
    enabled = false
    println "‚ö†Ô∏è Skipping unit tests on ARM64 architecture (Robolectric requires x86_64)"
  }
}

tasks.register('buildKeyboardFont') {
  // Skip font building if font already exists
  def fontFile = file("assets/special_font.ttf")
  if (fontFile.exists()) {
    println "\nSpecial font already exists, skipping build"
    return
  }

  println "\nBuilding assets/special_font.ttf"
  mkdir "$buildDir"
  exec {
    workingDir "$projectDir/srcs/special_font"
    def svgFiles = workingDir.listFiles().findAll {
      it.isFile() && it.name.endsWith(".svg")
    }
    commandLine("fontforge", "-lang=ff", "-script", "build.pe", "$buildDir/special_font.ttf", *svgFiles)
  }
  copy {
    from "$buildDir/special_font.ttf"
    into "assets"
  }
}

tasks.register('genEmojis') {
  println "\nGenerating res/raw/emojis.txt"
  exec {
    workingDir = projectDir
    commandLine "python", "gen_emoji.py"
  }
}

tasks.withType(Test).configureEach {
  dependsOn 'genLayoutsList'
  dependsOn 'checkKeyboardLayouts'
  dependsOn 'compileComposeSequences'
}

tasks.register('genLayoutsList') {
  println "\nGenerating res/values/layouts.xml"
  exec {
    workingDir = projectDir
    commandLine "python", "gen_layouts.py"
  }
}

tasks.register('checkKeyboardLayouts') {
  println "\nChecking layouts"
  exec {
    workingDir = projectDir
    commandLine("python", "check_layout.py")
  }
}

tasks.register('compileComposeSequences') {
  def out = "src/main/kotlin/tribixbite/keyboard2/ComposeKeyData.kt"
  println "\nGenerating ${out} (4050 compose sequences ‚Üí 8659 states)"
  exec {
    workingDir = projectDir
    commandLine("python3", "generate_compose_data.py")
    standardOutput = new FileOutputStream("${projectDir}/${out}")
    errorOutput = System.err  // Keep warnings/errors in console, not in generated file
  }
}

tasks.register('generateVersionInfo') {
  doLast {
    def gitCommit = 'git rev-parse --short HEAD'.execute().text.trim()
    def gitCommitFull = 'git rev-parse HEAD'.execute().text.trim()
    def gitDate = 'git log -1 --format=%cd --date=short'.execute().text.trim()
    def buildDate = new Date().format('yyyy-MM-dd HH:mm:ss')
    def buildNumber = System.currentTimeMillis().toString()
    
    def versionFile = file("build/generated-resources/raw/version_info.txt")
    versionFile.parentFile.mkdirs()
    versionFile.text = """commit=$gitCommit
commit_full=$gitCommitFull
commit_date=$gitDate
build_date=$buildDate
build_number=$buildNumber
"""
    
    println "Generated version info: $gitCommit ($gitDate)"
  }
}

tasks.named("preBuild") {
  dependsOn += "initDebugKeystore"
  dependsOn += "copyRawQwertyUS"
  dependsOn += "copyLayoutDefinitions"
  dependsOn += "generateVersionInfo"
}

tasks.register('initDebugKeystore') {
  if (!file("debug.keystore").exists()) {
    println "Initializing default debug keystore"
    exec {
      // A shell script might be needed if this line requires input from the user
      commandLine "keytool", "-genkeypair", "-dname", "cn=d, ou=e, o=b, c=ug", "-alias", "debug", "-keypass", "debug0", "-keystore", "debug.keystore", "-keyalg", "rsa", "-storepass", "debug0", "-validity", "10000"
    }
  }
}

// latn_qwerty_us is used as a raw resource by the custom layout option.
tasks.register('copyRawQwertyUS')
{
  copy {
    from "srcs/layouts/latn_qwerty_us.xml"
    into "build/generated-resources/raw"
  }
}

tasks.register('copyLayoutDefinitions')
{
  copy {
    from "src/main/layouts"
    include "*.xml"
    into "build/generated-resources/xml"
  }
}
