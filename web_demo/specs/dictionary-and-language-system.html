<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionary & Languages - CleverKeys Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ck-purple': '#9b59b6',
                        'ck-purple-dark': '#6b21a8',
                        'ck-purple-light': '#c39bd3',
                        'ck-dark': '#0f0f1a',
                        'ck-surface': '#1a1a2e',
                        'ck-card': '#242438',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #9b59b6 0%, #c39bd3 50%, #9b59b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-ck-dark text-gray-100 min-h-screen">
    <!-- Nav -->
    <nav class="sticky top-0 bg-ck-dark/95 backdrop-blur border-b border-gray-800 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../" class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/tribixbite/CleverKeys/main/res/mipmap-xxxhdpi/ic_launcher.png" alt="CleverKeys" class="w-8 h-8 rounded-lg">
                <span class="font-bold">CleverKeys</span>
            </a>
            <div class="flex gap-4">
                <a href="./" class="text-gray-400 hover:text-white transition-colors">All Specs</a>
                <a href="../" class="text-gray-400 hover:text-white transition-colors">Home</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container mx-auto px-6 py-4 pt-20">
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <a href="../" class="hover:text-ck-purple">Home</a>
            <span>/</span>
            <a href="./" class="hover:text-ck-purple">Specs</a>
            <span>/</span>
            <span class="text-gray-300">Dictionary & Languages</span>
        </div>
    </div>

    <!-- Header -->
    <header class="container mx-auto px-6 pb-8">
        <div class="flex items-center gap-3 mb-4">
            <span class="px-3 py-1 text-sm rounded-full" style="background: #1abc9c20; color: #1abc9c">Languages</span>
            <span class="px-3 py-1 text-sm rounded-full bg-ck-card text-gray-400">v1.1.84</span>
        </div>
        <h1 class="text-4xl font-bold gradient-text mb-2">Dictionary & Languages</h1>
        <p class="text-xl text-gray-400">Multi-language support and language packs</p>
    </header>

    <!-- Content -->
    <main class="container mx-auto px-6 pb-20">
        <div class="bg-ck-surface rounded-2xl p-8 max-w-4xl">
            <h1 class="text-3xl font-bold mb-6 gradient-text">Dictionary and Multi-Language System</h1>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Overview</h2>

<p class="mb-4 text-gray-300">The dictionary system manages word lookup, frequency ranking, and multi-language support through a tiered architecture. It combines static dictionaries, user-defined words, and neural prediction models into a "Language Pack" system with automatic language detection for bilingual typing.</p>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Key Files</h2>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">File</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Class/Function</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Purpose</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/OptimizedVocabularyImpl.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">OptimizedVocabulary</code></td><td class="px-4 py-2 text-gray-300">Dictionary lookup and filtering</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/data/LanguageDetector.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">LanguageDetector</code></td><td class="px-4 py-2 text-gray-300">Word-based language detection</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/WordPredictor.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">WordPredictor</code></td><td class="px-4 py-2 text-gray-300">Unified prediction pipeline</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">assets/dictionaries/{lang}_enhanced.bin</code></td><td class="px-4 py-2 text-gray-300">Binary dictionaries</td><td class="px-4 py-2 text-gray-300">Trie-based word storage</td></tr></tbody></table>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Architecture</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Language Pack Structure</h3>

<p class="mb-4 text-gray-300">Each language pack is a self-contained unit:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">Language Pack ({lang})
├── dictionaries/{lang}_enhanced.bin    # Trie-based vocabulary
├── dictionaries/{lang}_unigrams.bin    # Top 1000 words for detection
├── models/swipe_encoder_{lang}.onnx    # Neural encoder
├── models/swipe_decoder_{lang}.onnx    # Neural decoder
├── layouts/{lang}_*.xml                # Keyboard layouts
└── metadata.json                       # Version, license info</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Dictionary Layers</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">┌─────────────────────────────────────────────────────────────┐
│                     SuggestionRanker                         │
│  Merges candidates from all layers with unified scoring      │
└─────────────────────────────────────────────────────────────┘
                            │
       ┌────────────────────┼────────────────────┐
       │                    │                    │
       ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Layer 1    │    │   Layer 2    │    │   Layer 3    │
│ Main Dict    │    │ User Dict    │    │ Custom Dict  │
│ (Read-Only)  │    │ (System)     │    │ (App-Local)  │
│              │    │              │    │              │
│ Language     │    │ Android      │    │ SharedPrefs  │
│ Pack Asset   │    │ UserDictionary│   │ user_dict    │
└──────────────┘    └──────────────┘    └──────────────┘
       │                    │                    │
       └────────────────────┼────────────────────┘
                            │
                            ▼
                   ┌──────────────┐
                   │   Layer 4    │
                   │ Disabled     │
                   │ Words Filter │
                   └──────────────┘</code></pre>

<p class="mb-4 text-gray-300"><strong>Resolution Logic:</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">1. Gather candidates from Layers 1, 2, 3</li>
<li class="ml-4">2. Filter out words in Layer 4 (disabled)</li>
<li class="ml-4">3. Score by frequency, source priority (Custom > User > Main), neural confidence</li>
</ul>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Implementation Details</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Accent Handling</h3>

<p class="mb-4 text-gray-300">The neural model uses a 26-letter vocabulary (a-z only). Accented words are handled through normalization:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Accent mapping: normalized → canonical forms
data class AccentMapping(
    val normalized: String,         // "cafe"
    val canonicalForms: List&lt;String&gt;, // ["café"]
    val frequencies: List&lt;Int&gt;
)

// Lookup flow:
// 1. User swipes "café" → trajectory matches "cafe" pattern
// 2. Prefix lookup: "caf" → finds normalized candidates
// 3. Each candidate maps to its accented canonical form</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Binary Dictionary Format (v2)</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">┌────────────────────────────────────────┐
│ HEADER (32 bytes)                      │
│  - Magic: "CKDICT" (6 bytes)           │
│  - Version: 2 (2 bytes)                │
│  - Language: "es" (4 bytes)            │
│  - Word Count (4 bytes)                │
│  - Trie Offset (4 bytes)               │
│  - Metadata Offset (4 bytes)           │
│  - Accent Map Offset (4 bytes)         │
├────────────────────────────────────────┤
│ TRIE DATA BLOCK                        │
│  - Compact trie of NORMALIZED words    │
│  - Terminal nodes store word_id        │
├────────────────────────────────────────┤
│ WORD METADATA BLOCK                    │
│  - Array indexed by word_id:           │
│    - Canonical string (UTF-8, varint)  │
│    - Frequency rank (UInt8, 0-255)     │
├────────────────────────────────────────┤
│ ACCENT MAP BLOCK (optional)            │
│  - normalized_word → [canonical_ids]   │
└────────────────────────────────────────┘</code></pre>

<p class="mb-4 text-gray-300"><strong>Frequency Ranking:</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; Rank 0 = most frequent word</li>
<li class="ml-4">&#8226; Rank 255 = least frequent</li>
<li class="ml-4">&#8226; Log-scaled quantization preserves relative ordering</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Language Detection</h3>

<p class="mb-4 text-gray-300">Word-based unigram frequency model:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">data class LanguageScore(
    val language: String,
    var score: Float = 0f,
    var consecutiveHits: Int = 0
)

// Detection algorithm:
// 1. Each language pack ships top 1000 unigrams
// 2. Maintain sliding window of last 5 committed words
// 3. Score each word against active language unigram lists
// 4. Track running score per language (exponentially decaying)

fun shouldSwitch(primary: LanguageScore, candidate: LanguageScore): Boolean {
    // Conservative threshold to prevent jitter
    return candidate.score &gt; primary.score * 2.0f &amp;&amp;
           candidate.consecutiveHits &gt;= 2
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Dual-Dictionary Mode</h3>

<p class="mb-4 text-gray-300">For bilingual typing (e.g., English + Spanish) without manual switching:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">fun calculateUnifiedScore(
    word: String,
    nnConfidence: Float,      // From ONNX model
    dictionaryRank: Int,      // 0-255, lower = more common
    languageContext: Float,   // 0.0-1.0, from detector
    isPrimaryLang: Boolean
): Float {
    val rankScore = 1.0f - (dictionaryRank / 255f)
    val langMultiplier = if (isPrimaryLang) 1.0f else languageContext
    val secondaryPenalty = if (isPrimaryLang) 1.0f else 0.9f

    return nnConfidence * rankScore * langMultiplier * secondaryPenalty
}</code></pre>

<p class="mb-4 text-gray-300"><strong>Deduplication:</strong> When word exists in both dictionaries, present only entry with higher final score.</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Manual Language Switching</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Triggered by Globe key or long-press Spacebar
fun switchLanguage(newLang: String) {
    // 1. Hot-swap MainDictionarySource
    dictionaryManager.loadMainDictionary(newLang)

    // 2. Load corresponding ONNX models
    multiLanguageManager.loadModels(newLang)

    // 3. Update keyboard layout if linked
    keyboardManager.switchLayout(newLang)
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Data Structures</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">data class DictionaryWord(
    val canonical: String,      // Display form with accents
    val normalized: String,     // Lookup key without accents
    val frequencyRank: Int,     // 0-255, lower = more common
    val source: WordSource,     // MAIN, USER, CUSTOM, SECONDARY
    var enabled: Boolean = true
)

enum class WordSource {
    MAIN,       // Primary language pack
    SECONDARY,  // Secondary language pack
    USER,       // Android UserDictionary
    CUSTOM      // App SharedPreferences
}

data class LanguageState(
    val primary: String,
    val secondary: String?,
    val detectedContext: String,
    val confidence: Float
)</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Key Classes</h3>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Class</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Purpose</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">DictionaryManager</code></td><td class="px-4 py-2 text-gray-300">Singleton holding active WordPredictor instances, handles language lifecycle</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">MultiLanguageManager</code></td><td class="px-4 py-2 text-gray-300">Manages ONNX sessions, handles auto-detection logic</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">SuggestionRanker</code></td><td class="px-4 py-2 text-gray-300">Merges candidates from multiple dictionaries with unified scoring</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">UnigramLanguageDetector</code></td><td class="px-4 py-2 text-gray-300">Word-based language detection using frequency lists</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">AccentNormalizer</code></td><td class="px-4 py-2 text-gray-300">Unicode normalization (NFD) + accent stripping</td></tr></tbody></table>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Performance Considerations</h3>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Aspect</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Strategy</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Trie lookups</td><td class="px-4 py-2 text-gray-300">O(L) where L = key length, <5ms</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Memory mapping</td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">MappedByteBuffer</code> for large dictionaries</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Async loading</td><td class="px-4 py-2 text-gray-300">Language switching on <code class="bg-ck-dark px-1 rounded">Dispatchers.IO</code></td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Lazy init</td><td class="px-4 py-2 text-gray-300">Secondary dictionary loaded only when enabled</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Memory cleanup</td><td class="px-4 py-2 text-gray-300">Inactive ONNX sessions unloaded after 60s</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Unigram cache</td><td class="px-4 py-2 text-gray-300">~100KB per language kept in memory</td></tr></tbody></table>
        </div>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 text-center text-gray-500 text-sm border-t border-gray-800">
        <p>CleverKeys Documentation - Generated from specs</p>
    </footer>
</body>
</html>