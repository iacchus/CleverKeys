<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Prediction - CleverKeys Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ck-purple': '#9b59b6',
                        'ck-purple-dark': '#6b21a8',
                        'ck-purple-light': '#c39bd3',
                        'ck-dark': '#0f0f1a',
                        'ck-surface': '#1a1a2e',
                        'ck-card': '#242438',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #9b59b6 0%, #c39bd3 50%, #9b59b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-ck-dark text-gray-100 min-h-screen">
    <!-- Nav -->
    <nav class="sticky top-0 bg-ck-dark/95 backdrop-blur border-b border-gray-800 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../" class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/tribixbite/CleverKeys/main/res/mipmap-xxxhdpi/ic_launcher.png" alt="CleverKeys" class="w-8 h-8 rounded-lg">
                <span class="font-bold">CleverKeys</span>
            </a>
            <div class="flex gap-4">
                <a href="./" class="text-gray-400 hover:text-white transition-colors">All Specs</a>
                <a href="../" class="text-gray-400 hover:text-white transition-colors">Home</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container mx-auto px-6 py-4 pt-20">
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <a href="../" class="hover:text-ck-purple">Home</a>
            <span>/</span>
            <a href="./" class="hover:text-ck-purple">Specs</a>
            <span>/</span>
            <span class="text-gray-300">Neural Prediction</span>
        </div>
    </div>

    <!-- Header -->
    <header class="container mx-auto px-6 pb-8">
        <div class="flex items-center gap-3 mb-4">
            <span class="px-3 py-1 text-sm rounded-full" style="background: #9b59b620; color: #9b59b6">Core</span>
            <span class="px-3 py-1 text-sm rounded-full bg-ck-card text-gray-400">v1.0.0</span>
        </div>
        <h1 class="text-4xl font-bold gradient-text mb-2">Neural Prediction</h1>
        <p class="text-xl text-gray-400">ONNX transformer-based swipe typing engine</p>
    </header>

    <!-- Content -->
    <main class="container mx-auto px-6 pb-20">
        <div class="bg-ck-surface rounded-2xl p-8 max-w-4xl">
            <h1 class="text-3xl font-bold mb-6 gradient-text">Neural Swipe Prediction System Specification</h1>

<p class="mb-4 text-gray-300"><strong>Feature</strong>: ONNX Transformer-Based Swipe-to-Text Prediction</p>
<p class="mb-4 text-gray-300"><strong>Status</strong>: ğŸŸ¢ IMPLEMENTED (P0 bugs resolved, P1-P2 remaining)</p>
<p class="mb-4 text-gray-300"><strong>Priority</strong>: P0 (Core functionality)</p>
<p class="mb-4 text-gray-300"><strong>Assignee</strong>: N/A</p>
<p class="mb-4 text-gray-300"><strong>Date Created</strong>: 2025-10-20</p>
<p class="mb-4 text-gray-300"><strong>Last Updated</strong>: 2025-12-04</p>

<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">TODOs</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">âœ… RESOLVED - Critical Systems (P0)</h3>

<p class="mb-4 text-gray-300">All critical systems are fully implemented and verified as of 2025-12-04:</p>

<p class="mb-4 text-gray-300">| Bug # | Issue | Resolution | Status |</p>
<p class="mb-4 text-gray-300">|-------|-------|------------|--------|</p>
<p class="mb-4 text-gray-300">| #257 | LanguageDetector missing | Implemented in <code class="bg-ck-dark px-1 rounded">data/LanguageDetector.kt</code> (313 lines) | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #259 | NgramModel missing | Implemented in <code class="bg-ck-dark px-1 rounded">NgramModel.kt</code> (350 lines) | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #262 | WordPredictor missing | Implemented in <code class="bg-ck-dark px-1 rounded">WordPredictor.kt</code> (782 lines) | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #263 | UserAdaptationManager missing | Implemented in <code class="bg-ck-dark px-1 rounded">data/UserAdaptationManager.kt</code> (291 lines) | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #273 | Training data lost on close | SQLite database implementation | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #274 | ML training system | External pipeline by design (ADR-003) | âœ… ARCHITECTURAL |</p>
<p class="mb-4 text-gray-300">| #275 | Async prediction | Kotlin coroutines (ADR-004) | âœ… ARCHITECTURAL |</p>
<p class="mb-4 text-gray-300">| #276 | Advanced gesture analysis | Neural network auto-learns features (ADR-005) | âœ… ARCHITECTURAL |</p>

<p class="mb-4 text-gray-300"><strong>Initialization Order Bug</strong> (2025-11-14): Fixed race condition in CleverKeysService.kt where WordPredictor was initialized before its dependencies.</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">âš ï¸ Outstanding Issues (P1-P2)</h3>

<p class="mb-4 text-gray-300">| Bug # | Issue | File | Impact | Est. Time |</p>
<p class="mb-4 text-gray-300">|-------|-------|------|--------|-----------|</p>
<p class="mb-4 text-gray-300">| #270 | Time delta calculation | SwipeMLData.kt | Training timestamps may be wrong | 1 hour |</p>
<p class="mb-4 text-gray-300">| #271 | Consecutive duplicate filtering | SwipeMLData.kt | Noisy training data | 1 hour |</p>
<p class="mb-4 text-gray-300">| #277 | Multi-language expansion | OptimizedVocabularyImpl.kt | Only English fully tested | 8-12 hours/language |</p>

<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">1. Feature Overview</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Purpose</h3>
<p class="mb-4 text-gray-300">Pure ONNX neural transformer architecture for converting swipe gestures into ranked word predictions. This is a <strong>complete architectural replacement</strong> of the original CGR (Continuous Gesture Recognition) system.</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Key Advantages Over Legacy CGR</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Modern ML</strong>: Transformer encoder-decoder vs. template matching</li>
<li class="ml-4">&#8226; <strong>Automatic Learning</strong>: Neural networks learn features from data</li>
<li class="ml-4">&#8226; <strong>Better Accuracy</strong>: Deep learning vs. statistical heuristics</li>
<li class="ml-4">&#8226; <strong>Scalability</strong>: Can improve with more training data</li>
<li class="ml-4">&#8226; <strong>Simplicity</strong>: 2000+ lines of Java CGR code replaced with ONNX inference</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Architecture Comparison</h3>

<p class="mb-4 text-gray-300"><strong>Original (Java - CGR System)</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">Swipe â†’ Manual Feature Engineering (40+ features) â†’
<p class="mb-4 text-gray-300">Template Matching â†’ Dictionary Lookup â†’</p>
<p class="mb-4 text-gray-300">Statistical Scoring â†’ Predictions</code></pre></p>

<p class="mb-4 text-gray-300"><strong>Modern (Kotlin - ONNX System)</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">Swipe â†’ Feature Extraction (6 features) â†’
<p class="mb-4 text-gray-300">Transformer Encoder â†’ Beam Search Decoder â†’</p>
<p class="mb-4 text-gray-300">Vocabulary Filter â†’ Predictions</code></pre></p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Current Status (Updated: 2025-11-14)</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Core Pipeline</strong>: âœ… COMPLETE (encoder + decoder + beam search)</li>
<li class="ml-4">&#8226; <strong>Feature Extraction</strong>: âœ… COMPLETE (smoothing, velocity, acceleration)</li>
<li class="ml-4">&#8226; <strong>Tokenization</strong>: âœ… COMPLETE (character-level)</li>
<li class="ml-4">&#8226; <strong>WordPredictor System</strong>: âœ… COMPLETE (dictionary, bigram, language detection, user adaptation)</li>
<li class="ml-4">&#8226; <strong>Vocabulary</strong>: âš ï¸ PARTIAL (English only, framework ready for multi-language)</li>
<li class="ml-4">&#8226; <strong>Training Data</strong>: âœ… COMPLETE (SQLite persistence - Bug #273 FIXED)</li>
<li class="ml-4">&#8226; <strong>Multi-Language</strong>: âš ï¸ FRAMEWORK READY (LanguageDetector implemented, assets needed)</li>
<li class="ml-4">&#8226; <strong>User Adaptation</strong>: âœ… COMPLETE (SharedPreferences-based learning)</li>
</ul>
<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">2. Requirements</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Functional Requirements</h3>

<p class="mb-4 text-gray-300"><strong>FR-1: Swipe Input Processing</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Capture touch coordinates (x, y) and timestamps</li>
<li class="ml-4">&#8226; âœ… Smooth trajectory (moving average, window=3)</li>
<li class="ml-4">&#8226; âœ… Calculate velocity (first derivative)</li>
<li class="ml-4">&#8226; âœ… Calculate acceleration (second derivative)</li>
<li class="ml-4">&#8226; âœ… Normalize coordinates [0,1] (device-independent)</li>
<li class="ml-4">&#8226; âœ… Detect nearest keys (real positions or QWERTY grid)</li>
<li class="ml-4">&#8226; âœ… Pad/truncate to 150 points (fixed sequence length)</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-2: ONNX Encoder Inference</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Input: trajectory_features [1, 150, 6], nearest_keys [1, 150]</li>
<li class="ml-4">&#8226; âœ… Model: swipe_model_character_quant.onnx (quantized)</li>
<li class="ml-4">&#8226; âœ… Output: memory tensor [1, 150, 256] (encoder representation)</li>
<li class="ml-4">&#8226; âœ… Transformer architecture with self-attention</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-3: Beam Search Decoder</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Batched inference (50-70% speedup vs sequential)</li>
<li class="ml-4">&#8226; âœ… Beam width: 8 (configurable)</li>
<li class="ml-4">&#8226; âœ… Max length: 20 characters</li>
<li class="ml-4">&#8226; âœ… SOS/EOS token handling</li>
<li class="ml-4">&#8226; âœ… Score tracking (log probabilities)</li>
<li class="ml-4">&#8226; âœ… Early termination on EOS</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-4: Post-Processing</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Token-to-character decoding</li>
<li class="ml-4">&#8226; âœ… Vocabulary filtering (dictionary lookup)</li>
<li class="ml-4">&#8226; âœ… Confidence score conversion (0-1000 scale)</li>
<li class="ml-4">&#8226; âœ… Ranking by score (descending)</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-5: Training Data Collection</strong> (COMPLETE)</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Persistent storage via SQLite (Bug #273 - FIXED)</li>
<li class="ml-4">&#8226; âš ï¸ Time delta calculation needs verification (Bug #270)</li>
<li class="ml-4">&#8226; âš ï¸ Consecutive duplicates filtering needs verification (Bug #271)</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-6: Multi-Language Support</strong> (FRAMEWORK READY)</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Language detection implemented (Bug #257 - FIXED)</li>
<li class="ml-4">&#8226; âš ï¸ Per-language models need assets (Bug #277)</li>
<li class="ml-4">&#8226; âš ï¸ User dictionaries framework ready, assets needed</li>
</ul>
<p class="mb-4 text-gray-300"><strong>FR-7: User Adaptation</strong> (COMPLETE)</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Personalization manager implemented (Bug #263 - FIXED)</li>
<li class="ml-4">&#8226; âœ… Frequency tracking via SharedPreferences</li>
<li class="ml-4">&#8226; âœ… User-specific corrections supported</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Non-Functional Requirements</h3>

<p class="mb-4 text-gray-300"><strong>NFR-1: Performance</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Encoder inference: < 30ms (achieved with quantization)</li>
<li class="ml-4">&#8226; âœ… Decoder inference: < 50ms (batched beam search)</li>
<li class="ml-4">&#8226; âœ… Total latency: < 100ms (end-to-end)</li>
<li class="ml-4">&#8226; âœ… Memory pooling (OptimizedTensorPool)</li>
<li class="ml-4">&#8226; âœ… GPU batching (BatchedMemoryOptimizer)</li>
</ul>
<p class="mb-4 text-gray-300"><strong>NFR-2: Accuracy</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âš ï¸ Top-1 accuracy: 65-75% (can improve with more training data)</li>
<li class="ml-4">&#8226; âš ï¸ Top-3 accuracy: 85-90% (needs vocabulary improvement)</li>
<li class="ml-4">&#8226; âš ï¸ Multi-language: Framework ready, needs asset files</li>
</ul>
<p class="mb-4 text-gray-300"><strong>NFR-3: Resource Usage</strong></p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Model size: ~8MB (quantized from ~30MB)</li>
<li class="ml-4">&#8226; âœ… Memory pooling prevents leaks</li>
<li class="ml-4">&#8226; âœ… Training data persisted to SQLite (Bug #273 FIXED)</li>
</ul>
<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">3. Technical Design</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">System Architecture</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<p class="mb-4 text-gray-300">â”‚                    USER INTERACTION                        â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚              SwipeDetector.kt (Touch Events)               â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - ACTION_DOWN: Start gesture                             â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - ACTION_MOVE: Collect points                            â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - ACTION_UP: Trigger prediction                          â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚         SwipeInput.kt (Data Encapsulation)                 â”‚</p>
<p class="mb-4 text-gray-300">â”‚  data class SwipeInput(                                    â”‚</p>
<p class="mb-4 text-gray-300">â”‚    coordinates: List&lt;PointF&gt;,                              â”‚</p>
<p class="mb-4 text-gray-300">â”‚    timestamps: List&lt;Long&gt;,                                 â”‚</p>
<p class="mb-4 text-gray-300">â”‚    touchedKeys: List&lt;Key&gt;                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚  )                                                         â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚      OnnxSwipePredictorImpl.kt (Core Pipeline)             â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚ SwipeTrajectoryProcessor (Feature Extraction)   â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - smoothTrajectory()                           â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - calculateVelocities()                        â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - calculateAccelerations()                     â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - normalizeCoordinates()                       â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - detectNearestKeys()                          â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - padOrTruncate(150 points)                    â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â”‚                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â–¼                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚ runEncoder() (Transformer Inference)            â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Create input tensors [1,150,6], [1,150]     â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Run ONNX encoder model                       â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Output: memory [1,150,256]                   â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â”‚                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â–¼                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚ runBeamSearch() (Character Decoding)            â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Initialize beams with SOS token              â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - BATCHED decoder inference (beam_width=8)     â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Expand hypotheses, track scores              â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Terminate on EOS or max_length               â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Return top N candidates                      â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â”‚                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚                         â–¼                                  â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚ SwipeTokenizer (Token â†” Character)              â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - decode([2,5,8,12,3]) â†’ "hello"              â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â”‚  - Special tokens: SOS=2, EOS=3, PAD=0, UNK=1   â”‚      â”‚</p>
<p class="mb-4 text-gray-300">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚    OptimizedVocabularyImpl.kt (Dictionary Filter)         â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Check words against dictionary (English only)          â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Filter OOV (out-of-vocabulary) predictions             â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Bug #277: Multi-language support missing               â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚         PredictionResult.kt (Output Format)                â”‚</p>
<p class="mb-4 text-gray-300">â”‚  data class PredictionResult(                              â”‚</p>
<p class="mb-4 text-gray-300">â”‚    words: List&lt;String&gt;,        // ["hello", "hallo"]      â”‚</p>
<p class="mb-4 text-gray-300">â”‚    scores: List&lt;Int&gt;,          // [950, 850]              â”‚</p>
<p class="mb-4 text-gray-300">â”‚    confidences: List&lt;Float&gt;    // [0.95, 0.85]            â”‚</p>
<p class="mb-4 text-gray-300">â”‚  )                                                         â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p>
<p class="mb-4 text-gray-300">                            â”‚</p>
<p class="mb-4 text-gray-300">                            â–¼</p>
<p class="mb-4 text-gray-300">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</p>
<p class="mb-4 text-gray-300">â”‚            SuggestionBar.kt (UI Display)                   â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Show top 3 predictions                                 â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Highlight by confidence color                          â”‚</p>
<p class="mb-4 text-gray-300">â”‚  - Handle user selection                                  â”‚</p>
<p class="mb-4 text-gray-300">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Critical Data Flows</h3>

<p class="mb-4 text-gray-300"><strong>1. Feature Extraction Pipeline</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Input: SwipeInput
<p class="mb-4 text-gray-300">val rawCoords = swipeInput.coordinates          // [(100,250), (102,251), ...]</p>
<p class="mb-4 text-gray-300">val timestamps = swipeInput.timestamps          // [1728567890123, 1728567890140, ...]</p>

<p class="mb-4 text-gray-300">// Step 1: Smoothing (moving average, window=3)</p>
<p class="mb-4 text-gray-300">val smoothed = smoothTrajectory(rawCoords)      // Reduce noise</p>

<p class="mb-4 text-gray-300">// Step 2: Velocity (first derivative)</p>
<p class="mb-4 text-gray-300">val velocities = calculateVelocities(smoothed, timestamps)</p>
<p class="mb-4 text-gray-300">// Formula: velocity = distance / time_delta (pixels/sec)</p>

<p class="mb-4 text-gray-300">// Step 3: Acceleration (second derivative)</p>
<p class="mb-4 text-gray-300">val accelerations = calculateAccelerations(velocities, timestamps)</p>
<p class="mb-4 text-gray-300">// Formula: accel = velocity_delta / time_delta (pixels/secÂ²)</p>

<p class="mb-4 text-gray-300">// Step 4: Normalization [0,1]</p>
<p class="mb-4 text-gray-300">val normalized = normalizeCoordinates(smoothed)</p>
<p class="mb-4 text-gray-300">// normalized_x = x / keyboardWidth, normalized_y = y / keyboardHeight</p>

<p class="mb-4 text-gray-300">// Step 5: Nearest key detection</p>
<p class="mb-4 text-gray-300">val nearestKeys = detectNearestKeys(normalized)</p>
<p class="mb-4 text-gray-300">// Returns character indices: a=4, b=5, ..., z=29</p>

<p class="mb-4 text-gray-300">// Step 6: Padding to 150 points</p>
<p class="mb-4 text-gray-300">val (features, keys, mask) = padOrTruncate(</p>
<p class="mb-4 text-gray-300">    normalized, velocities, accelerations, nearestKeys, 150</p>
<p class="mb-4 text-gray-300">)</p>

<p class="mb-4 text-gray-300">// Output tensors:</p>
<p class="mb-4 text-gray-300">// trajectory_features: [1, 150, 6] (x, y, vx, vy, ax, ay)</p>
<p class="mb-4 text-gray-300">// nearest_keys: [1, 150] (character indices)</p>
<p class="mb-4 text-gray-300">// src_mask: [1, 150] (attention mask - 1=real, 0=padding)</code></pre></p>

<p class="mb-4 text-gray-300"><strong>2. Beam Search Algorithm</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Initialize beams with SOS token
<p class="mb-4 text-gray-300">var beams = listOf(Beam(tokens=[SOS], score=0.0))</p>

<p class="mb-4 text-gray-300">for (step in 0 until max_length) {</p>
<p class="mb-4 text-gray-300">    // BATCHED inference: all beams in single model call</p>
<p class="mb-4 text-gray-300">    val batchSize = beams.size</p>
<p class="mb-4 text-gray-300">    val inputIds = beams.map { it.tokens }.toBatchTensor()  // [batch, seq_len]</p>

<p class="mb-4 text-gray-300">    // Run decoder model</p>
<p class="mb-4 text-gray-300">    val logits = runDecoder(memory, inputIds)  // [batch, vocab_size]</p>

<p class="mb-4 text-gray-300">    // Expand each beam</p>
<p class="mb-4 text-gray-300">    val newBeams = mutableListOf&lt;Beam&gt;()</p>
<p class="mb-4 text-gray-300">    for ((beamIdx, beam) in beams.withIndex()) {</p>
<p class="mb-4 text-gray-300">        val topK = logits[beamIdx].topK(beam_width)  // Get top K tokens</p>

<p class="mb-4 text-gray-300">        for ((tokenIdx, logProb) in topK) {</p>
<p class="mb-4 text-gray-300">            if (tokenIdx == EOS) {</p>
<p class="mb-4 text-gray-300">                finishedBeams.add(beam.copy(score = beam.score + logProb))</p>
<p class="mb-4 text-gray-300">            } else {</p>
<p class="mb-4 text-gray-300">                newBeams.add(Beam(</p>
<p class="mb-4 text-gray-300">                    tokens = beam.tokens + tokenIdx,</p>
<p class="mb-4 text-gray-300">                    score = beam.score + logProb</p>
<p class="mb-4 text-gray-300">                ))</p>
<p class="mb-4 text-gray-300">            }</p>
<p class="mb-4 text-gray-300">        }</p>
<p class="mb-4 text-gray-300">    }</p>

<p class="mb-4 text-gray-300">    // Keep top beam_width beams by score</p>
<p class="mb-4 text-gray-300">    beams = newBeams.sortedByDescending { it.score }.take(beam_width)</p>

<p class="mb-4 text-gray-300">    // Early termination if all beams finished</p>
<p class="mb-4 text-gray-300">    if (beams.isEmpty()) break</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">// Return best finished beams</p>
<p class="mb-4 text-gray-300">return finishedBeams.sortedByDescending { it.score }</code></pre></p>

<p class="mb-4 text-gray-300"><strong>3. Token-to-Character Decoding</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Token indices â†’ Characters
<p class="mb-4 text-gray-300">val CHAR_MAP = mapOf(</p>
<p class="mb-4 text-gray-300">    4 to 'a', 5 to 'b', 6 to 'c', ..., 29 to 'z',</p>
<p class="mb-4 text-gray-300">    30 to ' ', 31 to '\'', 32 to '-'</p>
<p class="mb-4 text-gray-300">)</p>

<p class="mb-4 text-gray-300">fun decode(tokens: List&lt;Int&gt;): String {</p>
<p class="mb-4 text-gray-300">    return tokens</p>
<p class="mb-4 text-gray-300">        .filter { it !in listOf(SOS, EOS, PAD, UNK) }</p>
<p class="mb-4 text-gray-300">        .mapNotNull { CHAR_MAP[it] }</p>
<p class="mb-4 text-gray-300">        .joinToString("")</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">// Example:</p>
<p class="mb-4 text-gray-300">// tokens: [2, 8, 5, 12, 12, 15, 3]  (SOS, h, e, l, l, o, EOS)</p>
<p class="mb-4 text-gray-300">// decoded: "hello"</code></pre></p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Model Architecture</h3>

<p class="mb-4 text-gray-300"><strong>Encoder Model</strong> (<code class="bg-ck-dark px-1 rounded">swipe_model_character_quant.onnx</code>):</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Type</strong>: Transformer encoder</li>
<li class="ml-4">&#8226; <strong>Input 1</strong>: <code class="bg-ck-dark px-1 rounded">trajectory_features</code> [batch, 150, 6]</li>
</ul><p class="mb-4 text-gray-300">  - Features: (x, y, velocity_x, velocity_y, accel_x, accel_y)</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Input 2</strong>: <code class="bg-ck-dark px-1 rounded">nearest_keys</code> [batch, 150]</li>
</ul><p class="mb-4 text-gray-300">  - Character indices detected under each point</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Input 3</strong>: <code class="bg-ck-dark px-1 rounded">src_mask</code> [batch, 150]</li>
</ul><p class="mb-4 text-gray-300">  - Attention mask (1=real point, 0=padding)</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Output</strong>: <code class="bg-ck-dark px-1 rounded">memory</code> [batch, 150, 256]</li>
</ul><p class="mb-4 text-gray-300">  - Encoded representation of swipe trajectory</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Size</strong>: ~4MB (quantized INT8)</li>
<li class="ml-4">&#8226; <strong>Layers</strong>: 6 transformer encoder layers</li>
<li class="ml-4">&#8226; <strong>Attention</strong>: Multi-head self-attention (8 heads)</li>
</ul>
<p class="mb-4 text-gray-300"><strong>Decoder Model</strong> (<code class="bg-ck-dark px-1 rounded">swipe_decoder_character_quant.onnx</code>):</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Type</strong>: Transformer decoder (character-level)</li>
<li class="ml-4">&#8226; <strong>Input 1</strong>: <code class="bg-ck-dark px-1 rounded">memory</code> [batch, 150, 256] (from encoder)</li>
<li class="ml-4">&#8226; <strong>Input 2</strong>: <code class="bg-ck-dark px-1 rounded">tgt_input_ids</code> [batch, seq_len] (partial sequence)</li>
<li class="ml-4">&#8226; <strong>Output</strong>: <code class="bg-ck-dark px-1 rounded">logits</code> [batch, seq_len, vocab_size=35]</li>
</ul><p class="mb-4 text-gray-300">  - Next character probabilities</p>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Size</strong>: ~4MB (quantized INT8)</li>
<li class="ml-4">&#8226; <strong>Vocabulary</strong>: 35 tokens (SOS, EOS, PAD, UNK, a-z, space, ', -)</li>
<li class="ml-4">&#8226; <strong>Max Length</strong>: 20 characters</li>
</ul>
<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">4. Implementation Plan</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Phase 1: Critical Bug Fixes (2-3 days)</h3>
<p class="mb-4 text-gray-300"><strong>Priority: P0 - Fix data loss and training bugs</strong></p>

<ul class="mb-4 space-y-1"><li class="ml-4">1. <strong>Bug #273: Persistent Training Data</strong></li>
</ul><p class="mb-4 text-gray-300">   - Create SQLite database schema</p>
<p class="mb-4 text-gray-300">   - Migrate SwipeMLDataStore to use Room/SQLite</p>
<p class="mb-4 text-gray-300">   - Implement batch insert for performance</p>
<p class="mb-4 text-gray-300">   - Add data export/import functionality</p>
<p class="mb-4 text-gray-300">   - Time: 4-6 hours</p>

<ul class="mb-4 space-y-1"><li class="ml-4">2. <strong>Bug #270: Time Delta Calculation</strong></li>
</ul><p class="mb-4 text-gray-300">   - Fix addRawPoint() timestamp logic</p>
<p class="mb-4 text-gray-300">   - Use proper millisecond differences</p>
<p class="mb-4 text-gray-300">   - Time: 1 hour</p>

<ul class="mb-4 space-y-1"><li class="ml-4">3. <strong>Bug #271: Consecutive Duplicate Filtering</strong></li>
</ul><p class="mb-4 text-gray-300">   - Add logic to skip duplicate keys in sequence</p>
<p class="mb-4 text-gray-300">   - Preserve only direction changes</p>
<p class="mb-4 text-gray-300">   - Time: 1 hour</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Phase 2: Multi-Language Support (1-2 weeks)</h3>
<p class="mb-4 text-gray-300"><strong>Priority: P1 - Enable multiple languages</strong></p>

<ul class="mb-4 space-y-1"><li class="ml-4">1. <strong>Bug #277: Multi-Language Infrastructure</strong></li>
</ul><p class="mb-4 text-gray-300">   - Add language detection (Bug #257 - 313 lines to port)</p>
<p class="mb-4 text-gray-300">   - Per-language ONNX models</p>
<p class="mb-4 text-gray-300">   - Per-language vocabularies</p>
<p class="mb-4 text-gray-300">   - User dictionary support</p>
<p class="mb-4 text-gray-300">   - Language switcher UI</p>
<p class="mb-4 text-gray-300">   - Time: 8-12 hours implementation + model training</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Phase 3: User Adaptation (2-3 weeks)</h3>
<p class="mb-4 text-gray-300"><strong>Priority: P1 - Personalization</strong></p>

<ul class="mb-4 space-y-1"><li class="ml-4">1. <strong>Bug #263: UserAdaptationManager</strong></li>
</ul><p class="mb-4 text-gray-300">   - Port UserAdaptationManager.java (291 lines)</p>
<p class="mb-4 text-gray-300">   - Frequency tracking</p>
<p class="mb-4 text-gray-300">   - User-specific corrections</p>
<p class="mb-4 text-gray-300">   - Personalized scoring adjustments</p>
<p class="mb-4 text-gray-300">   - Time: 12-16 hours</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Phase 4: Training Infrastructure (4-6 weeks - External)</h3>
<p class="mb-4 text-gray-300"><strong>Priority: P0 - Enable model improvements</strong></p>

<ul class="mb-4 space-y-1"><li class="ml-4">1. <strong>Bug #274: ML Training System (External)</strong></li>
</ul><p class="mb-4 text-gray-300">   - Python/PyTorch training pipeline</p>
<p class="mb-4 text-gray-300">   - Data preprocessing scripts</p>
<p class="mb-4 text-gray-300">   - Model architecture definition</p>
<p class="mb-4 text-gray-300">   - Training loop with validation</p>
<p class="mb-4 text-gray-300">   - ONNX export scripts</p>
<p class="mb-4 text-gray-300">   - Time: 2-3 weeks (full infrastructure)</p>
<p class="mb-4 text-gray-300">   - Note: This is INTENTIONAL external training (ADR-003)</p>

<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">5. Testing Strategy</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Unit Tests</h3>

<p class="mb-4 text-gray-300"><strong>Feature Extraction Tests</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Test
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">smoothTrajectory reduces noise</code>() {</p>
<p class="mb-4 text-gray-300">    val noisy = listOf(</p>
<p class="mb-4 text-gray-300">        PointF(100f, 100f),</p>
<p class="mb-4 text-gray-300">        PointF(105f, 102f),  // Noise spike</p>
<p class="mb-4 text-gray-300">        PointF(102f, 101f)</p>
<p class="mb-4 text-gray-300">    )</p>
<p class="mb-4 text-gray-300">    val smoothed = smoothTrajectory(noisy)</p>
<p class="mb-4 text-gray-300">    assertTrue(smoothed[1].x &lt; noisy[1].x)  // Spike reduced</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">@Test</p>
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">velocity calculation is correct</code>() {</p>
<p class="mb-4 text-gray-300">    val coords = listOf(PointF(0f, 0f), PointF(100f, 0f))</p>
<p class="mb-4 text-gray-300">    val timestamps = listOf(0L, 1000L)  // 1 second apart</p>
<p class="mb-4 text-gray-300">    val velocities = calculateVelocities(coords, timestamps)</p>
<p class="mb-4 text-gray-300">    assertEquals(100f, velocities[0], 0.1f)  // 100 pixels/sec</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">@Test</p>
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">padding extends to 150 points</code>() {</p>
<p class="mb-4 text-gray-300">    val coords = List(50) { PointF(it.toFloat(), 0f) }</p>
<p class="mb-4 text-gray-300">    val (features, _, mask) = padOrTruncate(coords, ..., 150)</p>
<p class="mb-4 text-gray-300">    assertEquals(150, features.size)</p>
<p class="mb-4 text-gray-300">    assertEquals(50, mask.count { it == 1 })  // 50 real, 100 padded</p>
<p class="mb-4 text-gray-300">}</code></pre></p>

<p class="mb-4 text-gray-300"><strong>Beam Search Tests</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Test
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">beam search returns top N candidates</code>() {</p>
<p class="mb-4 text-gray-300">    val memory = createMockMemory()</p>
<p class="mb-4 text-gray-300">    val beams = runBeamSearch(memory, beamWidth=8, maxLength=10)</p>
<p class="mb-4 text-gray-300">    assertTrue(beams.size &lt;= 8)</p>
<p class="mb-4 text-gray-300">    assertTrue(beams[0].score &gt;= beams[1].score)  // Sorted by score</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">@Test</p>
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">beam search terminates on EOS</code>() {</p>
<p class="mb-4 text-gray-300">    val memory = createMockMemory()</p>
<p class="mb-4 text-gray-300">    val beams = runBeamSearch(memory, beamWidth=1, maxLength=20)</p>
<p class="mb-4 text-gray-300">    assertTrue(beams[0].tokens.last() == EOS || beams[0].tokens.size == 20)</p>
<p class="mb-4 text-gray-300">}</code></pre></p>

<p class="mb-4 text-gray-300"><strong>Tokenization Tests</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Test
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">decode converts tokens to string</code>() {</p>
<p class="mb-4 text-gray-300">    val tokens = listOf(SOS, 8, 5, 12, 12, 15, EOS)  // "hello"</p>
<p class="mb-4 text-gray-300">    val decoded = SwipeTokenizer.decode(tokens)</p>
<p class="mb-4 text-gray-300">    assertEquals("hello", decoded)</p>
<p class="mb-4 text-gray-300">}</p>

<p class="mb-4 text-gray-300">@Test</p>
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">decode filters special tokens</code>() {</p>
<p class="mb-4 text-gray-300">    val tokens = listOf(SOS, PAD, 8, UNK, EOS)</p>
<p class="mb-4 text-gray-300">    val decoded = SwipeTokenizer.decode(tokens)</p>
<p class="mb-4 text-gray-300">    assertEquals("h", decoded)  // Only 'h' remains</p>
<p class="mb-4 text-gray-300">}</code></pre></p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Integration Tests</h3>

<p class="mb-4 text-gray-300"><strong>End-to-End Pipeline</strong>:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Test
<p class="mb-4 text-gray-300">fun <code class="bg-ck-dark px-1 rounded">full pipeline produces predictions</code>() {</p>
<p class="mb-4 text-gray-300">    val swipeInput = SwipeInput(</p>
<p class="mb-4 text-gray-300">        coordinates = createMockSwipe(),  // Simulate "hello" swipe</p>
<p class="mb-4 text-gray-300">        timestamps = createMockTimestamps(),</p>
<p class="mb-4 text-gray-300">        touchedKeys = emptyList()</p>
<p class="mb-4 text-gray-300">    )</p>

<p class="mb-4 text-gray-300">    val predictions = onnxPredictor.predict(swipeInput)</p>

<p class="mb-4 text-gray-300">    assertTrue(predictions.words.isNotEmpty())</p>
<p class="mb-4 text-gray-300">    assertTrue(predictions.words[0] in listOf("hello", "hallo", "hell"))</p>
<p class="mb-4 text-gray-300">    assertTrue(predictions.scores[0] &gt; predictions.scores[1])</p>
<p class="mb-4 text-gray-300">}</code></pre></p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Manual Testing Checklist</h3>

<ul class="mb-4 space-y-1"><li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Swipe "hello" â†’ predicts "hello" in top 3</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Swipe with noise â†’ smoothing reduces jitter</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Very short swipe (< 10 points) â†’ pads correctly</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Very long swipe (> 200 points) â†’ truncates to 150</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Fast swipe â†’ velocity/acceleration calculated</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Slow swipe â†’ low velocity values</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> Multi-language model (if implemented) â†’ correct language detected</li>
<li class="flex items-center gap-2"><span class="text-gray-500">&#9633;</span> User dictionary (if implemented) â†’ custom words appear</li>
</ul>
<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">6. Success Criteria</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Functional Success</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Encoder inference < 30ms</li>
<li class="ml-4">&#8226; âœ… Decoder inference < 50ms (batched)</li>
<li class="ml-4">&#8226; âœ… Total latency < 100ms</li>
<li class="ml-4">&#8226; âœ… Training data persists across sessions (Bug #273 FIXED - SQLite)</li>
<li class="ml-4">&#8226; âš ï¸ Multi-language support (Bug #277 - framework ready, assets needed)</li>
<li class="ml-4">&#8226; âœ… User adaptation (Bug #263 FIXED)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Technical Success</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… ONNX models load and run</li>
<li class="ml-4">&#8226; âœ… Beam search produces ranked candidates</li>
<li class="ml-4">&#8226; âœ… Vocabulary filtering works</li>
<li class="ml-4">&#8226; âœ… Memory pooling prevents leaks</li>
<li class="ml-4">&#8226; âš ï¸ Top-3 accuracy â‰¥ 85% (can improve with more training data)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">User Experience Success</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; âœ… Predictions appear quickly (< 100ms)</li>
<li class="ml-4">&#8226; âš ï¸ Top prediction usually correct (65-75% currently)</li>
<li class="ml-4">&#8226; âœ… Learns from user corrections (UserAdaptationManager implemented)</li>
<li class="ml-4">&#8226; âš ï¸ Multi-language switching (framework ready, needs assets)</li>
</ul>
<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">7. References</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Documentation</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Technical Reference</strong>: <code class="bg-ck-dark px-1 rounded">docs/ONNX_DECODE_PIPELINE.md</code> (28,319 bytes)</li>
<li class="ml-4">&#8226; <strong>Architectural Decisions</strong>: <code class="bg-ck-dark px-1 rounded">docs/specs/architectural-decisions.md</code> (ADR-001 to ADR-006)</li>
<li class="ml-4">&#8226; <strong>Review Status</strong>: <code class="bg-ck-dark px-1 rounded">docs/COMPLETE_REVIEW_STATUS.md</code> (Files 41-50, 57-100)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Source Files</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Core Pipeline</strong>: <code class="bg-ck-dark px-1 rounded">OnnxSwipePredictorImpl.kt</code> (~1500 lines)</li>
<li class="ml-4">&#8226; <strong>Feature Extraction</strong>: SwipeTrajectoryProcessor (embedded)</li>
<li class="ml-4">&#8226; <strong>Beam Search</strong>: runBeamSearch() method</li>
<li class="ml-4">&#8226; <strong>Tokenization</strong>: SwipeTokenizer (embedded)</li>
<li class="ml-4">&#8226; <strong>Vocabulary</strong>: <code class="bg-ck-dark px-1 rounded">OptimizedVocabularyImpl.kt</code></li>
<li class="ml-4">&#8226; <strong>Training Data</strong>: <code class="bg-ck-dark px-1 rounded">SwipeMLData.kt</code>, <code class="bg-ck-dark px-1 rounded">SwipeMLDataStore.kt</code></li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Models</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Encoder</strong>: <code class="bg-ck-dark px-1 rounded">assets/models/swipe_model_character_quant.onnx</code> (~4MB)</li>
<li class="ml-4">&#8226; <strong>Decoder</strong>: <code class="bg-ck-dark px-1 rounded">assets/models/swipe_decoder_character_quant.onnx</code> (~4MB)</li>
<li class="ml-4">&#8226; <strong>Vocabulary</strong>: <code class="bg-ck-dark px-1 rounded">assets/models/vocabulary.txt</code> (English words)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Bug Reports</h3>

<p class="mb-4 text-gray-300">| Bug # | Description | Status |</p>
<p class="mb-4 text-gray-300">|-------|-------------|--------|</p>
<p class="mb-4 text-gray-300">| #257 | LanguageDetector missing | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #259 | NgramModel missing | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #262 | WordPredictor integration | âœ… ARCHITECTURAL (works alongside ONNX) |</p>
<p class="mb-4 text-gray-300">| #263 | UserAdaptationManager missing | âœ… FIXED |</p>
<p class="mb-4 text-gray-300">| #270 | Time delta calculation | âš ï¸ Needs verification |</p>
<p class="mb-4 text-gray-300">| #271 | Consecutive duplicates filter | âš ï¸ Needs verification |</p>
<p class="mb-4 text-gray-300">| #273 | Training data persistence | âœ… FIXED (SQLite) |</p>
<p class="mb-4 text-gray-300">| #274 | ML training external | âœ… ARCHITECTURAL (by design) |</p>
<p class="mb-4 text-gray-300">| #275 | Async prediction | âœ… ARCHITECTURAL (coroutines) |</p>
<p class="mb-4 text-gray-300">| #276 | Trace analyzer | âœ… ARCHITECTURAL (neural features) |</p>
<p class="mb-4 text-gray-300">| #277 | Multi-language expansion | âš ï¸ Framework ready, needs assets |</p>

<hr class="border-gray-700 my-6">

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">8. Notes</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Why ONNX Over CGR</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>ADR-001</strong>: Pure ONNX neural prediction (intentional replacement)</li>
<li class="ml-4">&#8226; <strong>ADR-002</strong>: Template generation â†’ neural training</li>
<li class="ml-4">&#8226; <strong>ADR-003</strong>: External ML training (Python/PyTorch)</li>
<li class="ml-4">&#8226; <strong>ADR-004</strong>: Coroutines over HandlerThread</li>
<li class="ml-4">&#8226; <strong>ADR-005</strong>: Neural feature learning (40+ features â†’ 6 features)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Implementation Complexity</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; <strong>Core Pipeline</strong>: âœ… COMPLETE (high complexity, well-implemented)</li>
<li class="ml-4">&#8226; <strong>Data Persistence</strong>: âœ… COMPLETE (SQLite implementation)</li>
<li class="ml-4">&#8226; <strong>Multi-Language</strong>: âš ï¸ FRAMEWORK READY (needs asset files for each language)</li>
<li class="ml-4">&#8226; <strong>User Adaptation</strong>: âœ… COMPLETE (SharedPreferences-based learning)</li>
</ul>
<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Future Enhancements</h3>
<ul class="mb-4 space-y-1"><li class="ml-4">1. On-device fine-tuning (federated learning)</li>
<li class="ml-4">2. Multilingual single model (instead of per-language)</li>
<li class="ml-4">3. Subword tokenization (BPE) for better vocabulary coverage</li>
<li class="ml-4">4. Contextual predictions (previous words)</li>
<li class="ml-4">5. Emoji/symbol prediction</li>
<li class="ml-4">6. Voice-to-swipe hybrid input</li>
</ul>
<hr class="border-gray-700 my-6">

<p class="mb-4 text-gray-300"><strong>Last Updated</strong>: 2025-12-04</p>
<p class="mb-4 text-gray-300"><strong>Status</strong>: âœ… Core complete, all P0 bugs resolved</p>
<p class="mb-4 text-gray-300"><strong>Priority</strong>: P1-P2 remaining (time delta calculation, duplicate filtering, multi-language expansion)</p>

        </div>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 text-center text-gray-500 text-sm border-t border-gray-800">
        <p>CleverKeys Documentation - Generated from specs</p>
    </footer>
</body>
</html>