<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings System - CleverKeys Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ck-purple': '#9b59b6',
                        'ck-purple-dark': '#6b21a8',
                        'ck-purple-light': '#c39bd3',
                        'ck-dark': '#0f0f1a',
                        'ck-surface': '#1a1a2e',
                        'ck-card': '#242438',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #9b59b6 0%, #c39bd3 50%, #9b59b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-ck-dark text-gray-100 min-h-screen">
    <!-- Nav -->
    <nav class="sticky top-0 bg-ck-dark/95 backdrop-blur border-b border-gray-800 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../" class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/tribixbite/CleverKeys/main/res/mipmap-xxxhdpi/ic_launcher.png" alt="CleverKeys" class="w-8 h-8 rounded-lg">
                <span class="font-bold">CleverKeys</span>
            </a>
            <div class="flex gap-4">
                <a href="./" class="text-gray-400 hover:text-white transition-colors">All Specs</a>
                <a href="../" class="text-gray-400 hover:text-white transition-colors">Home</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container mx-auto px-6 py-4 pt-20">
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <a href="../" class="hover:text-ck-purple">Home</a>
            <span>/</span>
            <a href="./" class="hover:text-ck-purple">Specs</a>
            <span>/</span>
            <span class="text-gray-300">Settings System</span>
        </div>
    </div>

    <!-- Header -->
    <header class="container mx-auto px-6 pb-8">
        <div class="flex items-center gap-3 mb-4">
            <span class="px-3 py-1 text-sm rounded-full" style="background: #f39c1220; color: #f39c12">Settings</span>
            <span class="px-3 py-1 text-sm rounded-full bg-ck-card text-gray-400">v1.0.0</span>
        </div>
        <h1 class="text-4xl font-bold gradient-text mb-2">Settings System</h1>
        <p class="text-xl text-gray-400">User preferences and keyboard configuration</p>
    </header>

    <!-- Content -->
    <main class="container mx-auto px-6 pb-20">
        <div class="bg-ck-surface rounded-2xl p-8 max-w-4xl">
            <h1 class="text-3xl font-bold mb-6 gradient-text">Settings System</h1>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Overview</h2>

<p class="mb-4 text-gray-300">The settings system manages user preferences through SharedPreferences, provides a Material 3 Compose UI for configuration, and applies settings at runtime via the Config singleton. All default values are centralized in the <code class="bg-ck-dark px-1 rounded">Defaults</code> object within Config.kt to prevent mismatches between UI display and actual behavior.</p>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Key Files</h2>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">File</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Class/Function</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Purpose</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/Config.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">Config</code>, <code class="bg-ck-dark px-1 rounded">Defaults</code></td><td class="px-4 py-2 text-gray-300">Global configuration singleton, centralized defaults</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/SettingsActivity.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">SettingsActivity</code></td><td class="px-4 py-2 text-gray-300">Material 3 Compose settings UI (~3000 lines)</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/ConfigurationManager.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">ConfigurationManager</code></td><td class="px-4 py-2 text-gray-300">Runtime configuration application</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/theme/KeyboardTheme.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">KeyboardTheme</code></td><td class="px-4 py-2 text-gray-300">Theme data and application</td></tr></tbody></table>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Architecture</h2>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">SettingsActivity (Material 3 Compose)
    ├── PreferenceScreen
    │   ├── Appearance Section
    │   ├── Input Behavior Section
    │   ├── Neural Prediction Section
    │   ├── Gestures Section
    │   ├── Layout Section
    │   ├── Clipboard Section
    │   └── Advanced Section
    ├── Config (reads SharedPreferences)
    └── ConfigurationManager (applies settings)

Defaults Architecture:
    └── Defaults object (Config.kt)
        ├── Single source of truth for all ~100 default values
        ├── Referenced by Config.kt refresh()
        ├── Referenced by SettingsActivity.kt loadCurrentSettings()
        └── Referenced by onSharedPreferenceChanged()

Storage Strategy:
    ├── SharedPreferences (settings data)
    ├── DirectBootAwarePreferences (device-protected storage)
    ├── App-specific storage (getExternalFilesDir)
    └── Scoped storage (Android 11+)</code></pre>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Configuration</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Defaults Object</h3>

<p class="mb-4 text-gray-300">The <code class="bg-ck-dark px-1 rounded">Defaults</code> object centralizes all app default values:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Config.kt
object Defaults {
    // Appearance
    const val THEME = "cleverkeysdark"
    const val KEYBOARD_HEIGHT_PORTRAIT = 28
    const val KEYBOARD_HEIGHT_LANDSCAPE = 50
    const val KEY_OPACITY = 1.0f
    const val KEY_BORDER_ENABLED = false

    // Input Behavior
    const val LONGPRESS_TIMEOUT = 600
    const val KEY_REPEAT_DELAY = 50
    const val VIBRATION_ENABLED = true
    const val VIBRATION_STRENGTH = 10

    // Neural Prediction
    const val NEURAL_BEAM_WIDTH = 6
    const val NEURAL_MAX_LENGTH = 20
    const val NEURAL_CONFIDENCE_THRESHOLD = 0.3f
    const val SWIPE_ENABLED = true

    // Gestures
    const val SHORT_GESTURE_MIN_DISTANCE = 15
    const val SHORT_GESTURE_MAX_DISTANCE = 50
    const val SLIDER_SENSITIVITY = 30
    const val TAP_DURATION_THRESHOLD = 200L

    // Clipboard
    const val CLIPBOARD_HISTORY_ENABLED = true
    const val CLIPBOARD_HISTORY_SIZE = 25
    const val CLIPBOARD_EXCLUDE_PASSWORD_MANAGERS = true

    // ... ~100 constants organized by category
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Settings Categories</h3>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Category</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Settings Count</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Key Settings</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Appearance</td><td class="px-4 py-2 text-gray-300">~15</td><td class="px-4 py-2 text-gray-300">theme, keyboard_height, opacity, borders</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Input Behavior</td><td class="px-4 py-2 text-gray-300">~10</td><td class="px-4 py-2 text-gray-300">longpress_timeout, vibration, key_repeat</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Neural</td><td class="px-4 py-2 text-gray-300">~8</td><td class="px-4 py-2 text-gray-300">beam_width, confidence, swipe_enabled</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Gestures</td><td class="px-4 py-2 text-gray-300">~12</td><td class="px-4 py-2 text-gray-300">short_swipe distances, slider sensitivity</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Layout</td><td class="px-4 py-2 text-gray-300">~8</td><td class="px-4 py-2 text-gray-300">margins, number_row, extra_keys</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Clipboard</td><td class="px-4 py-2 text-gray-300">~5</td><td class="px-4 py-2 text-gray-300">history_enabled, history_size, exclusions</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Accessibility</td><td class="px-4 py-2 text-gray-300">~6</td><td class="px-4 py-2 text-gray-300">sticky_keys, voice_guidance</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300">Debug</td><td class="px-4 py-2 text-gray-300">~4</td><td class="px-4 py-2 text-gray-300">debug_mode, logging</td></tr></tbody></table>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Public API</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Config Singleton</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">class Config private constructor(context: Context) {
    companion object {
        private var instance: Config? = null

        fun globalConfig(): Config = instance
            ?: throw IllegalStateException("Config not initialized")

        fun initialize(context: Context) {
            instance = Config(context)
        }
    }

    // Refresh from SharedPreferences
    fun refresh() {
        val prefs = context.getSharedPreferences("cleverkeys_prefs", MODE_PRIVATE)
        theme = prefs.getString("theme", Defaults.THEME)!!
        keyboardHeightPortrait = prefs.getInt("keyboard_height_portrait", Defaults.KEYBOARD_HEIGHT_PORTRAIT)
        neuralBeamWidth = prefs.getInt("neural_beam_width", Defaults.NEURAL_BEAM_WIDTH)
        // ... all other settings
    }

    // Save individual setting
    fun saveSetting(key: String, value: Any) {
        val prefs = context.getSharedPreferences("cleverkeys_prefs", MODE_PRIVATE)
        prefs.edit().apply {
            when (value) {
                is String -&gt; putString(key, value)
                is Int -&gt; putInt(key, value)
                is Boolean -&gt; putBoolean(key, value)
                is Float -&gt; putFloat(key, value)
            }
            apply()
        }
        refresh()
    }
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">SettingsActivity</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">class SettingsActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            CleverKeysSettingsTheme {
                SettingsScreen(
                    onNavigateBack = { finish() }
                )
            }
        }
    }
}

@Composable
fun SettingsScreen(onNavigateBack: () -&gt; Unit) {
    // Collapsible sections for each category
    var appearanceExpanded by remember { mutableStateOf(false) }
    var inputExpanded by remember { mutableStateOf(false) }
    // ...

    LazyColumn {
        item { SettingsSection("Appearance", appearanceExpanded, { appearanceExpanded = it }) {
            ThemePicker()
            HeightSlider()
            OpacitySlider()
        }}
        item { SettingsSection("Input Behavior", inputExpanded, { inputExpanded = it }) {
            VibrationToggle()
            LongpressSlider()
        }}
        // ... other sections
    }
}</code></pre>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Implementation Details</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Settings UI Components</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Composable
fun SettingsSwitch(
    title: String,
    description: String,
    checked: Boolean,
    onCheckedChange: (Boolean) -&gt; Unit
) {
    Row(modifier = Modifier.fillMaxWidth().padding(16.dp)) {
        Column(modifier = Modifier.weight(1f)) {
            Text(title, style = MaterialTheme.typography.bodyLarge)
            Text(description, style = MaterialTheme.typography.bodySmall)
        }
        Switch(checked = checked, onCheckedChange = onCheckedChange)
    }
}

@Composable
fun SettingsSlider(
    title: String,
    value: Float,
    range: ClosedFloatingPointRange&lt;Float&gt;,
    onValueChange: (Float) -&gt; Unit
) {
    Column(modifier = Modifier.fillMaxWidth().padding(16.dp)) {
        Text(title, style = MaterialTheme.typography.bodyLarge)
        Slider(value = value, valueRange = range, onValueChange = onValueChange)
    }
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Storage Permissions (Android 11+)</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-xml">&lt;!-- AndroidManifest.xml --&gt;
&lt;!-- Legacy permissions for Android 10 and below --&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
    android:maxSdkVersion="29" /&gt;
&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
    android:maxSdkVersion="29" /&gt;

&lt;!-- For Android 11+, use scoped storage via MediaStore or SAF --&gt;</code></pre>

<p class="mb-4 text-gray-300">App-specific storage doesn't require permissions:</p>
<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">val appDir = context.getExternalFilesDir(null)  // No permission needed</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Theme Application</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// ConfigurationManager.kt
fun applyTheme(themeName: String) {
    val theme = KeyboardTheme.loadTheme(context, themeName)
    KeyboardTheme.current = theme

    // Notify keyboard view to redraw
    CleverKeysService.getInstance()?.requestKeyboardRedraw()
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Settings Change Listener</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">class Config(context: Context) : SharedPreferences.OnSharedPreferenceChangeListener {
    init {
        prefs.registerOnSharedPreferenceChangeListener(this)
    }

    override fun onSharedPreferenceChanged(prefs: SharedPreferences, key: String?) {
        when (key) {
            "theme" -&gt; {
                theme = prefs.getString("theme", Defaults.THEME)!!
                ConfigurationManager.applyTheme(theme)
            }
            "keyboard_height_portrait" -&gt; {
                keyboardHeightPortrait = prefs.getInt(key, Defaults.KEYBOARD_HEIGHT_PORTRAIT)
                CleverKeysService.getInstance()?.requestKeyboardResize()
            }
            // ... handle other settings
        }
    }
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Collapsible Sections Pattern</h3>

<p class="mb-4 text-gray-300">Settings UI uses collapsible sections (not hierarchical navigation):</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">@Composable
fun CollapsibleSection(
    title: String,
    expanded: Boolean,
    onExpandedChange: (Boolean) -&gt; Unit,
    content: @Composable ColumnScope.() -&gt; Unit
) {
    Column {
        Row(
            modifier = Modifier.clickable { onExpandedChange(!expanded) }
                .fillMaxWidth().padding(16.dp)
        ) {
            Text(title, style = MaterialTheme.typography.titleMedium)
            Spacer(Modifier.weight(1f))
            Icon(
                if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                contentDescription = null
            )
        }
        AnimatedVisibility(visible = expanded) {
            Column(content = content)
        }
    }
}</code></pre>

<p class="mb-4 text-gray-300">This pattern means settings paths are "Settings > [expand section] > [setting]" rather than hierarchical navigation like "Settings > Appearance > Theme".</p>

        </div>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 text-center text-gray-500 text-sm border-t border-gray-800">
        <p>CleverKeys Documentation - Generated from specs</p>
    </footer>
</body>
</html>