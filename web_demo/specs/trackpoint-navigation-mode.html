<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackPoint Navigation - CleverKeys Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ck-purple': '#9b59b6',
                        'ck-purple-dark': '#6b21a8',
                        'ck-purple-light': '#c39bd3',
                        'ck-dark': '#0f0f1a',
                        'ck-surface': '#1a1a2e',
                        'ck-card': '#242438',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #9b59b6 0%, #c39bd3 50%, #9b59b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-ck-dark text-gray-100 min-h-screen">
    <!-- Nav -->
    <nav class="sticky top-0 bg-ck-dark/95 backdrop-blur border-b border-gray-800 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../" class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/tribixbite/CleverKeys/main/res/mipmap-xxxhdpi/ic_launcher.png" alt="CleverKeys" class="w-8 h-8 rounded-lg">
                <span class="font-bold">CleverKeys</span>
            </a>
            <div class="flex gap-4">
                <a href="./" class="text-gray-400 hover:text-white transition-colors">All Specs</a>
                <a href="../" class="text-gray-400 hover:text-white transition-colors">Home</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container mx-auto px-6 py-4 pt-20">
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <a href="../" class="hover:text-ck-purple">Home</a>
            <span>/</span>
            <a href="./" class="hover:text-ck-purple">Specs</a>
            <span>/</span>
            <span class="text-gray-300">TrackPoint Navigation</span>
        </div>
    </div>

    <!-- Header -->
    <header class="container mx-auto px-6 pb-8">
        <div class="flex items-center gap-3 mb-4">
            <span class="px-3 py-1 text-sm rounded-full" style="background: #3498db20; color: #3498db">Gestures</span>
            <span class="px-3 py-1 text-sm rounded-full bg-ck-card text-gray-400">v1.2.4</span>
        </div>
        <h1 class="text-4xl font-bold gradient-text mb-2">TrackPoint Navigation</h1>
        <p class="text-xl text-gray-400">Joystick-style cursor control on navigation keys</p>
    </header>

    <!-- Content -->
    <main class="container mx-auto px-6 pb-20">
        <div class="bg-ck-surface rounded-2xl p-8 max-w-4xl">
            <h1 class="text-3xl font-bold mb-6 gradient-text">TrackPoint Navigation Mode</h1>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Overview</h2>

<p class="mb-4 text-gray-300">TrackPoint Navigation Mode provides joystick-style cursor control by holding arrow keys (without initial swipe movement). When activated, finger movement in any direction moves the cursor proportionally, with speed scaling based on distance from the activation point. Supports all 8 directions including diagonals for fluid text navigation.</p>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Key Files</h2>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">File</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Class/Function</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Purpose</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/Pointers.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">handleTrackPointRepeat()</code></td><td class="px-4 py-2 text-gray-300">Main cursor movement logic</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/Pointers.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">FLAG_P_TRACKPOINT_MODE</code></td><td class="px-4 py-2 text-gray-300">Mode state flag (value: 64)</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/VibratorCompat.kt</code></td><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">CLOCK_TICK</code> pattern</td><td class="px-4 py-2 text-gray-300">Distinct haptic on activation</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">src/main/kotlin/tribixbite/cleverkeys/Config.kt</code></td><td class="px-4 py-2 text-gray-300">Haptic toggle</td><td class="px-4 py-2 text-gray-300">TrackPoint haptic setting</td></tr></tbody></table>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Architecture</h2>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-text">User Input (arrow key touch + hold without movement)
       |
       v
+------------------+
| onTouchDown()    | -- Records initial touch position
+------------------+
       |
       v (no initial movement + hold time exceeded)
+------------------+
| TrackPoint Mode  | -- FLAG_P_TRACKPOINT_MODE activated
| Activation       | -- CLOCK_TICK haptic feedback
+------------------+
       |
       v
+------------------+
| handleTrackPoint | -- Repeating handler tracks position
| Repeat()         | -- Calculates direction and distance
+------------------+
       |
       v
+------------------+
| Cursor Movement  | -- Sends DPAD_* key events
| Handler          | -- Supports all 8 directions
+------------------+</code></pre>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Data Flow</h2>

<ul class="mb-4 space-y-1"><li class="ml-4">1. <strong>Activation</strong>: Hold arrow key without initial swipe movement</li>
<li class="ml-4">2. <strong>Detection</strong>: After <code class="bg-ck-dark px-1 rounded">LONGPRESS_TIMEOUT</code> with <30px movement, mode activates</li>
<li class="ml-4">3. <strong>Tracking</strong>: Repeat handler reads current finger position</li>
<li class="ml-4">4. <strong>Direction</strong>: Calculate angle from activation point to current position</li>
<li class="ml-4">5. <strong>Speed</strong>: Distance from center determines repeat rate</li>
<li class="ml-4">6. <strong>Output</strong>: Appropriate DPAD_* key events sent to input connection</li>
</ul>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Configuration</h2>

<table class="w-full mb-4 border-collapse"><thead class="border-b border-gray-700"><tr><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Key</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Type</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Default</th><th class="px-4 py-2 text-left font-semibold text-ck-purple-light">Description</th></tr></thead><tbody><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">trackpoint_haptic_enabled</code></td><td class="px-4 py-2 text-gray-300">Boolean</td><td class="px-4 py-2 text-gray-300">true</td><td class="px-4 py-2 text-gray-300">Enable CLOCK_TICK on mode activation</td></tr><tr class="border-b border-gray-800"><td class="px-4 py-2 text-gray-300"><code class="bg-ck-dark px-1 rounded">short_gesture_min_distance</code></td><td class="px-4 py-2 text-gray-300">Int</td><td class="px-4 py-2 text-gray-300">15</td><td class="px-4 py-2 text-gray-300">Pixels before short swipe detection (30px for nav keys)</td></tr></tbody></table>
<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Public API</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Pointers.kt</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// State flag constant
private const val FLAG_P_TRACKPOINT_MODE = 64

// Timer identifier for repeat handler
private val trackpointWhat = Any()

// Main TrackPoint handler - called repeatedly while mode active
private fun handleTrackPointRepeat(ptr: Pointer) {
    val dx = ptr.currentX - ptr.activationX
    val dy = ptr.currentY - ptr.activationY

    // Calculate 8-direction from delta
    val direction = getTrackPointDirection(dx, dy)

    // Send cursor movement(s)
    sendCursorMovement(direction)
}

// Get direction enum from delta coordinates
private fun getTrackPointDirection(dx: Float, dy: Float): TrackPointDirection

// Send arrow key event(s) for direction
private fun sendCursorMovement(direction: TrackPointDirection)

// Trigger activation haptic
private fun triggerTrackPointHaptic()</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Direction Enumeration</h3>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">enum class TrackPointDirection {
    NORTH,      // Up only
    NORTHEAST,  // Up + Right
    EAST,       // Right only
    SOUTHEAST,  // Down + Right
    SOUTH,      // Down only
    SOUTHWEST,  // Down + Left
    WEST,       // Left only
    NORTHWEST   // Up + Left
}</code></pre>

<h2 class="text-2xl font-bold mt-8 mb-4 text-ck-purple">Implementation Details</h2>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Activation vs Short Swipe</h3>

<p class="mb-4 text-gray-300">TrackPoint mode activates when:</p>
<ul class="mb-4 space-y-1"><li class="ml-4">1. Arrow key touched</li>
<li class="ml-4">2. Finger moved <30px from initial position (nav keys use 30px, others use 15px)</li>
<li class="ml-4">3. Hold time exceeds <code class="bg-ck-dark px-1 rounded">LONGPRESS_TIMEOUT</code> (600ms)</li>
</ul>
<p class="mb-4 text-gray-300">If finger moves >30px before timeout, it's a short swipe (single cursor move).</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">// Nav keys have increased tolerance to allow hold activation
val isNavKey = key.kind in listOf(Kind.Arrow_Up, Kind.Arrow_Down, Kind.Arrow_Left, Kind.Arrow_Right)
val movementThreshold = if (isNavKey) 30 else 15

if (distance &lt; movementThreshold &amp;&amp; holdTime &gt; LONGPRESS_TIMEOUT) {
    activateTrackPointMode(ptr)
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Direction Calculation</h3>

<p class="mb-4 text-gray-300">Direction determined by angle from activation point:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">private fun getTrackPointDirection(dx: Float, dy: Float): TrackPointDirection {
    val angle = atan2(dy.toDouble(), dx.toDouble())
    val degrees = Math.toDegrees(angle)

    // Map angle to 8 sectors (45 degrees each)
    return when {
        degrees in -22.5..22.5 -&gt; EAST
        degrees in 22.5..67.5 -&gt; SOUTHEAST
        degrees in 67.5..112.5 -&gt; SOUTH
        degrees in 112.5..157.5 -&gt; SOUTHWEST
        degrees &gt; 157.5 || degrees &lt; -157.5 -&gt; WEST
        degrees in -157.5..-112.5 -&gt; NORTHWEST
        degrees in -112.5..-67.5 -&gt; NORTH
        degrees in -67.5..-22.5 -&gt; NORTHEAST
        else -&gt; EAST // fallback
    }
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Diagonal Movement</h3>

<p class="mb-4 text-gray-300">Diagonal directions send two key events:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">private fun sendCursorMovement(direction: TrackPointDirection) {
    when (direction) {
        NORTH -&gt; sendArrowKey(KEYCODE_DPAD_UP)
        NORTHEAST -&gt; {
            sendArrowKey(KEYCODE_DPAD_UP)
            sendArrowKey(KEYCODE_DPAD_RIGHT)
        }
        EAST -&gt; sendArrowKey(KEYCODE_DPAD_RIGHT)
        SOUTHEAST -&gt; {
            sendArrowKey(KEYCODE_DPAD_DOWN)
            sendArrowKey(KEYCODE_DPAD_RIGHT)
        }
        SOUTH -&gt; sendArrowKey(KEYCODE_DPAD_DOWN)
        SOUTHWEST -&gt; {
            sendArrowKey(KEYCODE_DPAD_DOWN)
            sendArrowKey(KEYCODE_DPAD_LEFT)
        }
        WEST -&gt; sendArrowKey(KEYCODE_DPAD_LEFT)
        NORTHWEST -&gt; {
            sendArrowKey(KEYCODE_DPAD_UP)
            sendArrowKey(KEYCODE_DPAD_LEFT)
        }
    }
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Speed Scaling</h3>

<p class="mb-4 text-gray-300">Cursor movement speed scales with finger distance from activation center:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">val distance = sqrt(dx * dx + dy * dy)
val repeatDelay = when {
    distance &lt; 50 -&gt; 200   // Slow (5 moves/sec)
    distance &lt; 100 -&gt; 100  // Medium (10 moves/sec)
    distance &lt; 150 -&gt; 50   // Fast (20 moves/sec)
    else -&gt; 25             // Very fast (40 moves/sec)
}
handler.postDelayed(trackpointRunnable, repeatDelay)</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Haptic Feedback</h3>

<p class="mb-4 text-gray-300">Distinct CLOCK_TICK pattern on activation:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">private fun triggerTrackPointHaptic() {
    if (config.trackpointHapticEnabled) {
        VibratorCompat.vibrate(HapticEvent.CLOCK_TICK)
    }
}</code></pre>

<p class="mb-4 text-gray-300">CLOCK_TICK provides a subtle, distinct feel different from normal key press vibration.</p>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Nav Key Exclusion from Gesture Collection</h3>

<p class="mb-4 text-gray-300">Arrow keys are excluded from short gesture path collection to prevent accidental gesture triggering:</p>

<pre class="bg-ck-dark p-4 rounded-lg overflow-x-auto"><code class="language-kotlin">private fun shouldCollectGesturePath(key: KeyValue): Boolean {
    // Nav keys excluded - they have TrackPoint mode instead
    if (key.kind in listOf(Kind.Arrow_Up, Kind.Arrow_Down, Kind.Arrow_Left, Kind.Arrow_Right)) {
        return false
    }
    return true
}</code></pre>

<h3 class="text-xl font-semibold mt-6 mb-3 text-ck-purple-light">Error Handling</h3>

<ul class="mb-4 space-y-1"><li class="ml-4">&#8226; No navigation target: Cursor movement commands sent but have no effect</li>
<li class="ml-4">&#8226; Haptic unavailable: Mode still functions, just without feedback</li>
<li class="ml-4">&#8226; Rapid re-activation: Debounced to prevent haptic spam (min 200ms between activations)</li>
</ul>
        </div>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 text-center text-gray-500 text-sm border-t border-gray-800">
        <p>CleverKeys Documentation - Generated from specs</p>
    </footer>
</body>
</html>